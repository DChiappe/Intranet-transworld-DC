<div class="contenedor">
  <div style="margin-bottom: 20px;">
    <a href="/marketing/eventos" class="link-volver">← Volver a Eventos</a>
  </div>

  <h2 class="page-title">Evento: <%= evento.nombre %></h2>
  
  <% if (evento.descripcion) { %>
    <p class="page-description" style="margin-bottom: 25px; font-style: italic; color: #555;">
      <%= evento.descripcion %>
    </p>
  <% } %>

  <% if (can.eventos_write) { %>
    <div class="panel" style="margin-bottom: 30px;">
      <h3 class="panel-title">Subir nuevas fotos</h3>
      <form action="/marketing/eventos/<%= evento.slug %>/fotos" method="POST" enctype="multipart/form-data" class="form-ticket">
        <input type="file" name="fotos" multiple accept="image/*" required style="margin-bottom: 10px; display: block;">
        <button type="submit" class="btn btn-primario">Subir a la nube</button>
      </form>
    </div>
  <% } %>

  <h3 class="panel-title">Galería de Imágenes</h3>

  <% if (!imagenes || imagenes.length === 0) { %>
    <p class="no-data">No hay imágenes cargadas para este evento aún.</p>
  <% } else { %>
    <div class="galeria-evento">
      <% imagenes.forEach(function(img) { %>
        <div class="galeria-item">
          <img
            src="<%= img.url %>"
            alt="<%= evento.nombre %>"
            class="galeria-thumb"
            data-full="<%= img.url %>"
            loading="lazy"
          >
          
          <% if (can.eventos_write) { %>
            <form action="/marketing/eventos/<%= evento.slug %>/fotos/eliminar" method="POST" onsubmit="return confirm('¿Eliminar esta foto?');" style="margin-top: 8px;">
              <input type="hidden" name="public_id" value="<%= img.public_id %>">
              <button type="submit" class="btn-borrar-foto">Eliminar</button>
            </form>
          <% } %>
        </div>
      <% }); %>
    </div>
  <% } %>
</div>

<div id="modalImagen" class="modal-imagen">
  <div class="modal-imagen-contenido">
    <span class="modal-cerrar">&times;</span>
    <img id="modalImagenGrande" src="" alt="Vista previa">
    
    <% if (can.eventos_write) { %>
      <form action="/marketing/eventos/<%= evento.slug %>/portada" method="POST" class="form-portada">
        <input type="hidden" name="url_imagen" id="inputPortadaUrl" value="">
        <button type="submit" class="btn-portada">Seleccionar como portada de evento</button>
      </form>
    <% } %>

  </div>
</div>

<style>
  /* Estilo del botón verde en el modal */
  .form-portada {
    position: absolute;
    bottom: 20px;
    right: 20px;
    z-index: 2010;
  }
  .btn-portada {
    background-color: #28a745; /* Verde */
    color: white;
    border: none;
    padding: 10px 16px;
    border-radius: 6px;
    font-weight: bold;
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    transition: background 0.2s;
  }
  .btn-portada:hover {
    background-color: #218838;
  }
  .modal-imagen-contenido {
    /* Aseguramos que sea relativo para posicionar el botón */
    position: relative; 
    display: flex;
    justify-content: center;
    align-items: center;
  }
</style>

<script>
  (function () {
    const modal = document.getElementById('modalImagen');
    const modalImg = document.getElementById('modalImagenGrande');
    const inputUrl = document.getElementById('inputPortadaUrl'); // Input oculto
    const cerrar = document.querySelector('.modal-cerrar');
    const thumbs = document.querySelectorAll('.galeria-thumb');

    thumbs.forEach(thumb => {
      thumb.addEventListener('click', function () {
        const fullUrl = this.getAttribute('data-full');
        
        // 1. Mostrar imagen
        modalImg.src = fullUrl;
        
        // 2. Cargar URL en el formulario de portada
        if(inputUrl) inputUrl.value = fullUrl;

        modal.style.display = 'flex';
      });
    });

    cerrar.addEventListener('click', () => modal.style.display = 'none');
    window.addEventListener('click', (e) => { if (e.target === modal) modal.style.display = 'none'; });
  })();
</script>