<div class="contenedor">
  <div style="margin-bottom: 20px;">
    <a href="/marketing/eventos" class="link-volver">← Volver a Eventos</a>
  </div>

  <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 10px;">
    <h2 class="page-title" style="margin: 0;">Evento: <%= evento.nombre %></h2>

    <% if (can.eventos_write) { %>
      <a href="/marketing/eventos/<%= evento.slug %>/editar" title="Editar título y descripción"
         style="text-decoration: none; font-size: 1.2rem; filter: grayscale(100%); transition: filter 0.2s;">
        ✏️
      </a>
      <style>a[title="Editar título y descripción"]:hover { filter: none !important; }</style>
    <% } %>
  </div>

  <% if (evento.descripcion) { %>
    <p class="page-description" style="margin-bottom: 25px; font-style: italic; color: #555;">
      <%= evento.descripcion %>
    </p>
  <% } %>

  <% if (can.eventos_write) { %>
    <div class="panel" style="margin-bottom: 30px;">
      <h3 class="panel-title">Subir nuevas fotos o videos</h3>

      <form
        id="uploadFotosForm"
        action="/marketing/eventos/<%= evento.slug %>/fotos"
        method="POST"
        enctype="multipart/form-data"
        class="form-ticket"
        data-slug="<%= evento.slug %>"
      >
        <input
          type="file"
          id="fotosInput"
          name="fotos"
          multiple
          accept="image/*,video/*" 
          required
          style="margin-bottom: 10px; display: block;"
        >

        <div id="uploadStatus" style="margin: 8px 0; font-size: 0.95rem; color: #555; display:none;"></div>

        <button type="submit" id="btnSubirFotos" class="btn btn-primario">Subir a la nube</button>
      </form>

      <small style="display:block; margin-top:10px; color:#666;">
        Imágenes máx 10MB. Videos máx 100MB. (Formatos recomendados: JPG, PNG, MP4).
      </small>
    </div>
  <% } %>

  <h3 class="panel-title">Galería Multimedia</h3>

  <% if (!imagenes || imagenes.length === 0) { %>
    <p class="no-data">No hay contenido cargado para este evento aún.</p>
  <% } else { %>
    <div class="galeria-evento-grid">
      <% imagenes.forEach(function(item) { %>
        
        <% 
           // --- OPTIMIZACIÓN CLOUDINARY ---
           let thumbUrl = item.url;
           let isVideo = (item.resource_type === 'video');

           if (thumbUrl.includes('/upload/')) {
              // Si es VIDEO, para el thumbnail forzamos extensión .jpg y usamos w_400
              if (isVideo) {
                 // Reemplaza la extensión final (ej .mp4) por .jpg
                 thumbUrl = thumbUrl.replace(/\.[^/.]+$/, ".jpg");
                 // Inyectamos transformaciones
                 thumbUrl = thumbUrl.replace('/upload/', '/upload/w_400,q_auto,f_auto,so_auto/'); 
                 // so_auto = start offset auto (intenta buscar un frame interesante)
              } else {
                 // Si es FOTO
                 thumbUrl = thumbUrl.replace('/upload/', '/upload/w_400,q_auto,f_auto/');
              }
           }
        %>

        <div class="galeria-item-grid">
          <div class="media-container" style="position: relative; height: 180px;">
            <img
              src="<%= thumbUrl %>"      
              alt="<%= evento.nombre %>"
              class="galeria-thumb-grid"
              data-full="<%= item.url %>"
              data-type="<%= item.resource_type %>"
              loading="lazy"
            >
            <% if (isVideo) { %>
              <div class="play-icon-overlay">▶</div>
            <% } %>
          </div>

          <% if (can.eventos_write) { %>
            <form action="/marketing/eventos/<%= evento.slug %>/fotos/eliminar" method="POST" onsubmit="return confirm('¿Eliminar este archivo?');" style="margin-top: 8px;">
              <input type="hidden" name="public_id" value="<%= item.public_id %>">
              <input type="hidden" name="resource_type" value="<%= item.resource_type %>">
              <button type="submit" class="btn-borrar-foto" style="width:100%">Eliminar</button>
            </form>
          <% } %>
        </div>
      <% }); %>
    </div>
  <% } %>
</div>

<div id="modalImagen" class="modal-imagen">
  <div class="modal-imagen-contenido">
    <span class="modal-cerrar">&times;</span>
    
    <div id="modalMediaContainer" style="display: flex; justify-content: center; width: 100%;">
        </div>

    <% if (can.eventos_write) { %>
      <form id="formPortada" action="/marketing/eventos/<%= evento.slug %>/portada" method="POST" class="form-portada" style="display:none;">
        <input type="hidden" name="url_imagen" id="inputPortadaUrl" value="">
        <button type="submit" class="btn-portada">Seleccionar como portada</button>
      </form>
    <% } %>

  </div>
</div>

<style>
  /* GRID RESPONSIVE */
  .galeria-evento-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 20px;
    margin-top: 20px;
  }

  .galeria-item-grid {
    background: #fff;
    padding: 8px;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    border: 1px solid #eee;
    display: flex;
    flex-direction: column;
  }

  .media-container {
    cursor: pointer;
    overflow: hidden;
    border-radius: 4px;
    background-color: #000;
  }

  .galeria-thumb-grid {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.2s, opacity 0.2s;
  }

  .media-container:hover .galeria-thumb-grid {
    transform: scale(1.02);
    opacity: 0.8;
  }

  .play-icon-overlay {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: white;
    font-size: 2.5rem;
    text-shadow: 0 0 10px rgba(0,0,0,0.7);
    pointer-events: none; /* Click pasa a la imagen */
  }

  /* MODAL */
  .form-portada {
    position: absolute;
    bottom: -50px; /* Sacarlo un poco de la imagen/video */
    right: 0;
    z-index: 2010;
  }
  .btn-portada {
    background-color: #28a745;
    color: white;
    border: none;
    padding: 10px 16px;
    border-radius: 6px;
    font-weight: bold;
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
  }
  .btn-portada:hover {
    background-color: #218838;
  }
  .modal-imagen-contenido {
    position: relative;
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    width: 100%;
    max-width: 900px; /* Ancho máximo para el modal */
  }
  .btn-borrar-foto {
    background: #dc3545;
    color: white; 
    border: none; 
    padding: 5px; 
    border-radius: 4px; 
    cursor: pointer;
  }
  
  /* Ajuste para video en modal */
  #modalMediaContainer video, #modalMediaContainer img {
    max-width: 100%;
    max-height: 80vh;
    border-radius: 4px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.5);
  }
</style>

<script>
  (function () {
    // ====== MODAL VISTA PREVIA ======
    const modal = document.getElementById('modalImagen');
    const container = document.getElementById('modalMediaContainer');
    const inputUrl = document.getElementById('inputPortadaUrl');
    const formPortada = document.getElementById('formPortada');
    const cerrar = document.querySelector('.modal-cerrar');
    const thumbs = document.querySelectorAll('.galeria-thumb-grid');

    thumbs.forEach(thumb => {
      thumb.addEventListener('click', function () {
        const fullUrl = this.getAttribute('data-full');
        const type = this.getAttribute('data-type'); // 'image' o 'video'

        // Limpiar contenedor
        container.innerHTML = '';

        if (type === 'video') {
            // Crear elemento VIDEO
            const video = document.createElement('video');
            video.src = fullUrl;
            video.controls = true;
            video.autoplay = true;
            container.appendChild(video);
            
            // Ocultar botón de portada (no soportado para videos en portada home)
            if (formPortada) formPortada.style.display = 'none';

        } else {
            // Crear elemento IMG
            const img = document.createElement('img');
            img.src = fullUrl;
            container.appendChild(img);

            // Mostrar botón de portada
            if (inputUrl) inputUrl.value = fullUrl;
            if (formPortada) formPortada.style.display = 'block';
        }

        modal.style.display = 'flex';
      });
    });

    // Función para cerrar y detener video
    function closeModal() {
        modal.style.display = 'none';
        container.innerHTML = ''; // Esto mata el video y detiene el sonido
    }

    if (cerrar) cerrar.addEventListener('click', closeModal);
    window.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });


    // ====== SUBIDA DIRECTA A CLOUDINARY (Soporte Videos) ======
    const form = document.getElementById('uploadFotosForm');
    if (!form) return;

    const input = document.getElementById('fotosInput');
    const btn = document.getElementById('btnSubirFotos');
    const status = document.getElementById('uploadStatus');

    const MAX_FILES = 30;
    const CONCURRENCY = 2; // Bajamos concurrencia para videos grandes

    function setStatus(text, visible = true) {
      if (!status) return;
      status.textContent = text;
      status.style.display = visible ? 'block' : 'none';
    }

    function disableUI(disabled) {
      if (btn) btn.disabled = disabled;
      if (input) input.disabled = disabled;
    }

    async function getSignature(slug) {
      const res = await fetch(`/marketing/eventos/${encodeURIComponent(slug)}/fotos/signature`, {
        method: 'GET',
        headers: { 'Accept': 'application/json' }
      });
      if (!res.ok) throw new Error('No se pudo obtener la firma de Cloudinary.');
      return res.json();
    }

    async function uploadOneToCloudinary(file, sig) {
      // Determinamos si es video o imagen
      const type = file.type.startsWith('video/') ? 'video' : 'image';
      
      // URL cambia según el tipo: /v1_1/cloud/video/upload o /image/upload
      const url = `https://api.cloudinary.com/v1_1/${encodeURIComponent(sig.cloudName)}/${type}/upload`;
      
      const fd = new FormData();
      fd.append('file', file);
      fd.append('api_key', sig.apiKey);
      fd.append('timestamp', String(sig.timestamp));
      fd.append('signature', sig.signature);
      fd.append('folder', sig.folder);

      const res = await fetch(url, { method: 'POST', body: fd });
      if (!res.ok) {
        const txt = await res.text().catch(() => '');
        throw new Error(`Error subiendo ${file.name}. ${txt}`);
      }
      const data = await res.json();
      
      // Devolvemos el resource_type también
      return { 
          secure_url: data.secure_url, 
          public_id: data.public_id,
          resource_type: data.resource_type 
      };
    }

    async function mapWithConcurrency(items, limit, mapper) {
      const results = new Array(items.length);
      let idx = 0;
      async function worker() {
        while (true) {
          const current = idx++;
          if (current >= items.length) return;
          results[current] = await mapper(items[current], current);
        }
      }
      const workers = [];
      for (let i = 0; i < Math.min(limit, items.length); i++) workers.push(worker());
      await Promise.all(workers);
      return results;
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const slug = form.getAttribute('data-slug');
      const files = input && input.files ? Array.from(input.files) : [];

      if (!files.length) { alert('Selecciona archivos.'); return; }
      if (files.length > MAX_FILES) { alert(`Máximo ${MAX_FILES} archivos.`); return; }

      // Validar tamaño (10MB img, 100MB video)
      for (let f of files) {
          const isVideo = f.type.startsWith('video/');
          const limit = isVideo ? 100 * 1024 * 1024 : 10 * 1024 * 1024;
          if (f.size > limit) {
              alert(`El archivo "${f.name}" es muy pesado. (Máx: 10MB Img / 100MB Video)`);
              return;
          }
      }

      try {
        disableUI(true);
        setStatus('Obteniendo firma...', true);
        const sig = await getSignature(slug);

        let done = 0;
        setStatus(`Subiendo: 0 / ${files.length}`, true);

        const uploaded = await mapWithConcurrency(files, CONCURRENCY, async (file) => {
          const out = await uploadOneToCloudinary(file, sig);
          done += 1;
          setStatus(`Subiendo: ${done} / ${files.length}`, true);
          return out;
        });

        setStatus('Guardando...', true);
        const res = await fetch(`/marketing/eventos/${encodeURIComponent(slug)}/fotos`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ images: uploaded }) // Enviamos array con resource_type incluido
        });

        if (!res.ok) throw new Error('Error guardando en base de datos.');

        setStatus('Listo. Recargando...', true);
        window.location.reload();
      } catch (err) {
        console.error(err);
        alert(err.message || 'Error en la subida.');
        disableUI(false);
        setStatus('', false);
      }
    });
  })();
</script>