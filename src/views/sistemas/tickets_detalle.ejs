<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title><%= titulo %></title>
  <link rel="stylesheet" href="/css/styles.css" />
</head>

<body class="intranet-body">

  <div class="contenedor pagina-ticket-detalle">
    <a class="link-volver" href="/sistemas/tickets">â† Volver al listado de tickets</a>
    <h2 class="page-title">Ticket #<%= ticket.id %></h2>

    <dl class="ticket-detalle">
      <dt>TÃ­tulo</dt> <dd><%= ticket.titulo %></dd>
      <dt>DescripciÃ³n</dt> <dd><pre class="ticket-descripcion"><%= ticket.descripcion %></pre></dd>
      <dt>Solicitante</dt> <dd><%= ticket.solicitante_nombre || '-' %> &lt;<%= ticket.solicitante_email %>&gt;</dd>
      <dt>Ãrea</dt> <dd><%= ticket.categoria || '-' %></dd>
      
      <dt>Importancia</dt>
      <dd>
        <% 
          let clasePrioridad = 'badge-verde';
          if (ticket.prioridad === 'Alta') clasePrioridad = 'badge-roja';
          else if (ticket.prioridad === 'Media') clasePrioridad = 'badge-amarilla';
        %>
        <span class="badge <%= clasePrioridad %>"><%= ticket.prioridad || 'Media' %></span>
      </dd>

      <dt>Estado</dt>
      <dd>
        <% 
          let claseEstado = 'badge-estado-abierto'; // Default rojo
          let textoEstado = ticket.estado || 'Abierto';
          
          if (textoEstado === 'Cerrado') claseEstado = 'badge-estado-cerrado'; // Verde
          else if (textoEstado === 'Resuelto') claseEstado = 'badge-amarilla'; // Amarillo (usando clase existente)
        %>
        <span class="badge <%= claseEstado %>"><%= textoEstado %></span>
      </dd>

      <dt>Creado</dt> 
      <dd class="small-text"><%= ticket.fecha_creacion ? new Date(ticket.fecha_creacion).toLocaleString('es-CL') : '-' %></dd>
    </dl>

    <% 
       const canManage = (user.role === 'admin');
       const isOwner = (ticket.solicitante_email === user.email);
    %>

    <% if (canManage) { %>
      <div class="panel panel-actualizar-ticket">
        <h3 class="panel-title">Gestionar Ticket</h3>
        <form action="/sistemas/tickets/<%= ticket.id %>/actualizar" method="POST" class="form-actualizar-ticket">
          
          <label for="categoria">CategorÃ­a</label>
          <select id="categoria" name="categoria">
            <option value="Sistemas" <%= ticket.categoria === 'Sistemas' ? 'selected' : '' %>>Sistemas</option>
            <option value="Otros" <%= ticket.categoria === 'Otros' ? 'selected' : '' %>>Otros</option>
            </select>

          <label for="prioridad">Prioridad</label>
          <select id="prioridad" name="prioridad">
            <option value="Alta" <%= ticket.prioridad === 'Alta' ? 'selected' : '' %>>ğŸ”´ Alta</option>
            <option value="Media" <%= ticket.prioridad === 'Media' ? 'selected' : '' %>>ğŸŸ¡ Media</option>
            <option value="Baja" <%= ticket.prioridad === 'Baja' ? 'selected' : '' %>>ğŸŸ¢ Baja</option>
          </select>

          <label for="estado">Estado</label>
          <select id="estado" name="estado">
            <option value="Abierto" <%= ticket.estado === 'Abierto' ? 'selected' : '' %>>ğŸ”´ Abierto</option>
            <option value="Resuelto" <%= ticket.estado === 'Resuelto' ? 'selected' : '' %>>ğŸŸ¡ Resuelto (Esperando confirmaciÃ³n)</option>
            <option value="Cerrado" <%= ticket.estado === 'Cerrado' ? 'selected' : '' %>>ğŸŸ¢ Cerrado</option>
          </select>

          <button type="submit" class="btn btn-primario">Actualizar</button>
        </form>
      </div>
    <% } %>

    <% if (isOwner && ticket.estado === 'Resuelto') { %>
      <div class="panel" style="background-color: #fff3cd; border: 1px solid #ffeeba;">
        <h3 class="panel-title" style="color: #856404;">ğŸ’¡ El soporte ha marcado este ticket como Resuelto</h3>
        <p style="margin-bottom: 15px;">Por favor, confirma si el problema se solucionÃ³ o si persiste.</p>
        
        <div style="display: flex; gap: 10px;">
          <form action="/sistemas/tickets/<%= ticket.id %>/confirmar" method="POST">
            <button type="submit" class="btn btn-primario" style="background-color: #28a745; border: none;">
              âœ… SÃ­, funciona (Cerrar Ticket)
            </button>
          </form>

          <form action="/sistemas/tickets/<%= ticket.id %>/rechazar" method="POST">
            <button type="submit" class="btn btn-primario" style="background-color: #dc3545; border: none;">
              âŒ No, aÃºn falla (Reabrir Ticket)
            </button>
          </form>
        </div>
      </div>
    <% } %>

    <% if ( (canManage || isOwner) && ticket.estado !== 'Cerrado' ) { %>
      <div class="panel panel-responder">
        <h3 class="panel-title">Agregar mensaje</h3>
        <form action="/sistemas/tickets/<%= ticket.id %>/responder" method="POST" class="form-responder-ticket">
          <% if (canManage) { %>
            <label for="asunto_respuesta">Asunto (Opcional)</label>
            <input type="text" id="asunto_respuesta" name="asunto_respuesta" placeholder="Ej: Solicitud de mÃ¡s datos">
          <% } %>

          <label for="mensaje_respuesta">Mensaje</label>
          <textarea id="mensaje_respuesta" name="mensaje_respuesta" rows="4" required></textarea>
          <button type="submit" class="btn btn-primario">Enviar mensaje</button>
        </form>
      </div>
    <% } else if (ticket.estado === 'Cerrado') { %>
      <div class="mensaje-info">Este ticket estÃ¡ cerrado y no admite mÃ¡s respuestas.</div>
    <% } %>

    <div class="panel panel-historial">
      <h3 class="panel-title">Historial de comunicaciÃ³n</h3>
      <% if (respuestas && respuestas.length > 0) { %>
        <% respuestas.forEach(r => { %>
          <div class="respuesta-item">
            <div class="respuesta-header">
              <strong class="respuesta-remitente"><%= r.remitente %></strong>
              <span class="small-text"><%= r.fecha ? new Date(r.fecha).toLocaleString('es-CL') : '' %></span>
            </div>
            <pre class="respuesta-mensaje"><%= r.mensaje %></pre>
          </div>
        <% }) %>
      <% } else { %>
        <p class="small-text">No hay mensajes.</p>
      <% } %>
    </div>

  </div>
</body>
</html>