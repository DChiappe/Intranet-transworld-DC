<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title><%= titulo %></title>
  <link rel="stylesheet" href="/css/styles.css" />
  <style>
    /* === ESTILOS PARA ADJUNTOS === */
    .adjuntos-wrapper { margin-top: 15px; border-top: 1px solid #eee; padding-top: 10px; }
    
    .seccion-adjunto { margin-bottom: 15px; }
    .titulo-adjunto { font-size: 0.85rem; font-weight: bold; color: #555; margin-bottom: 8px; display: flex; align-items: center; gap: 5px; }
    
    /* 1. IM√ÅGENES (C√≠rculos lado a lado) */
    .grid-imagenes { 
        display: flex; 
        gap: 15px; 
        flex-wrap: wrap; 
    }
    .thumb-imagen {
        width: 100px;
        height: 100px;
        border-radius: 50%; /* C√≠rculo perfecto */
        object-fit: cover;
        border: 3px solid #eee;
        transition: transform 0.2s, border-color 0.2s;
        cursor: pointer;
        background-color: #f0f0f0;
    }
    .thumb-imagen:hover {
        transform: scale(1.05);
        border-color: #28a745; /* Verde al pasar mouse */
    }

    /* 2. DOCUMENTOS (Lista vertical) */
    .lista-docs { 
        display: flex; 
        flex-direction: column; 
        gap: 6px; 
    }
    .item-doc {
        background: #f8f9fa;
        padding: 8px 12px;
        border-radius: 6px;
        border-left: 4px solid #003a70;
        display: flex;
        align-items: center;
        font-size: 0.9rem;
        text-decoration: none;
        color: #333;
        transition: background 0.2s;
        width: fit-content;
    }
    .item-doc:hover { background: #e9ecef; }
    .item-doc span { font-weight: 600; margin-left: 5px; }

    /* 3. VIDEOS (Rect√°ngulos lado a lado) */
    .grid-videos { 
        display: flex; 
        gap: 15px; 
        flex-wrap: wrap; 
    }
    .item-video {
        width: 200px;
        background: #000;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .item-video video {
        width: 100%;
        height: 120px;
        object-fit: cover;
        display: block;
    }
    
    /* Peque√±o texto de estado de subida */
    .status-upload { font-size: 0.85rem; margin-top: 5px; font-weight: bold; }
  </style>
</head>

<body class="intranet-body">

  <div class="contenedor pagina-ticket-detalle">
    <a class="link-volver" href="/sistemas/tickets">‚Üê Volver al listado de tickets</a>
    <h2 class="page-title">Ticket #<%= ticket.id %></h2>

    <dl class="ticket-detalle">
      <dt>T√≠tulo</dt> <dd><%= ticket.titulo %></dd>
      <dt>Descripci√≥n</dt> <dd><pre class="ticket-descripcion"><%= ticket.descripcion %></pre></dd>
      <dt>Solicitante</dt> <dd><%= ticket.solicitante_nombre || '-' %> &lt;<%= ticket.solicitante_email %>&gt;</dd>
      <dt>Estado</dt> 
      <dd>
        <% 
           let claseEstado = 'badge-estado-abierto'; 
           if (ticket.estado === 'Cerrado') claseEstado = 'badge-estado-cerrado';
           else if (ticket.estado === 'Resuelto') claseEstado = 'badge-amarilla';
        %>
        <span class="badge <%= claseEstado %>"><%= ticket.estado %></span>
      </dd>
    </dl>

    <% 
       const canManage = (user.role === 'admin');
       const isOwner = (ticket.solicitante_email === user.email);
    %>

    <% if (canManage) { %>
      <div class="panel panel-actualizar-ticket">
        <h3 class="panel-title">Gestionar Ticket</h3>
        <form id="formAdmin" action="/sistemas/tickets/<%= ticket.id %>/actualizar" method="POST" class="form-actualizar-ticket">
          <label>Estado</label>
          <select name="estado">
             <option value="Abierto" <%= ticket.estado==='Abierto'?'selected':'' %>>Abierto</option>
             <option value="Resuelto" <%= ticket.estado==='Resuelto'?'selected':'' %>>Resuelto</option>
             <option value="Cerrado" <%= ticket.estado==='Cerrado'?'selected':'' %>>Cerrado</option>
          </select>

          <label style="margin-top:15px;">Mensaje (Opcional)</label>
          <textarea name="mensaje_respuesta" rows="4" style="resize:vertical; max-height:400px;"></textarea>

          <input type="hidden" name="adjuntos_data" id="admin_adjuntos_data" value="[]">

          <div style="margin-top: 10px;">
             <input type="file" id="fileAdmin" multiple accept="image/*,video/*,.pdf,.doc,.docx" style="display: none;">
             <button type="button" class="btn btn-primario" onclick="document.getElementById('fileAdmin').click()">üìé Adjuntar archivos</button>
             <div id="statusAdmin" class="status-upload"></div>
          </div>

          <button type="submit" class="btn btn-primario" style="margin-top: 15px; background-color: #002a52;">Actualizar ticket</button>
        </form>
      </div>
    <% } %>

    <% if ( (canManage || isOwner) && ticket.estado !== 'Cerrado' ) { %>
      <div class="panel panel-responder">
        <h3 class="panel-title">Agregar mensaje</h3>
        <form id="formUser" action="/sistemas/tickets/<%= ticket.id %>/responder" method="POST" class="form-responder-ticket">
          <textarea name="mensaje_respuesta" rows="4" placeholder="Escribe tu respuesta..." style="resize:vertical; max-height:400px;"></textarea>

          <input type="hidden" name="adjuntos_data" id="user_adjuntos_data" value="[]">

          <div style="margin-top: 10px;">
             <input type="file" id="fileUser" multiple accept="image/*,video/*,.pdf,.doc,.docx" style="display: none;">
             <button type="button" class="btn btn-primario" onclick="document.getElementById('fileUser').click()">üìé Adjuntar archivos</button>
             <div id="statusUser" class="status-upload"></div>
          </div>

          <button type="submit" class="btn btn-primario" style="margin-top: 15px;">Enviar mensaje</button>
        </form>
      </div>
    <% } %>

    <div class="panel panel-historial">
      <h3 class="panel-title">Historial de comunicaci√≥n</h3>
      <% if (respuestas && respuestas.length > 0) { %>
        <% respuestas.forEach(r => { %>
          <div class="respuesta-item">
            <div class="respuesta-header">
              <strong class="respuesta-remitente"><%= r.remitente %></strong>
              <span class="small-text"><%= r.fecha ? new Date(r.fecha).toLocaleString('es-CL') : '' %></span>
            </div>
            <pre class="respuesta-mensaje"><%= r.mensaje %></pre>
            
            <% 
               let archivos = [];
               if (r.adjuntos) {
                 try { archivos = JSON.parse(r.adjuntos); } catch(e){}
               } else if (r.archivo_url) {
                 // Compatibilidad antigua
                 archivos.push({
                   url: r.archivo_url,
                   nombre: r.archivo_nombre || 'Adjunto',
                   tipo: r.archivo_tipo || 'image'
                 });
               }

               // Filtrar por grupos
               let imagenes = archivos.filter(a => a.tipo === 'image');
               let videos   = archivos.filter(a => a.tipo === 'video');
               let docs     = archivos.filter(a => a.tipo !== 'image' && a.tipo !== 'video');
            %>

            <% if (archivos.length > 0) { %>
                <div class="adjuntos-wrapper">
                    
                    <% if (imagenes.length > 0) { %>
                        <div class="seccion-adjunto">
                            <div class="titulo-adjunto">üìé Imagen adjunta:</div>
                            <div class="grid-imagenes">
                                <% imagenes.forEach(img => { %>
                                    <a href="<%= img.url %>" target="_blank">
                                        <img src="<%= img.url %>" class="thumb-imagen" title="<%= img.nombre %>">
                                    </a>
                                <% }) %>
                            </div>
                        </div>
                    <% } %>

                    <% if (docs.length > 0) { %>
                        <div class="seccion-adjunto">
                            <div class="titulo-adjunto">üìé Archivo adjunto:</div>
                            <div class="lista-docs">
                                <% docs.forEach(doc => { %>
                                    <a href="<%= doc.url %>" target="_blank" class="item-doc">
                                        üìÑ <span><%= doc.nombre %></span>
                                    </a>
                                <% }) %>
                            </div>
                        </div>
                    <% } %>

                    <% if (videos.length > 0) { %>
                        <div class="seccion-adjunto">
                            <div class="titulo-adjunto">üìé Video adjunto:</div>
                            <div class="grid-videos">
                                <% videos.forEach(vid => { %>
                                    <div class="item-video">
                                        <video src="<%= vid.url %>" controls title="<%= vid.nombre %>"></video>
                                    </div>
                                <% }) %>
                            </div>
                        </div>
                    <% } %>

                </div>
            <% } %>

          </div>
        <% }) %>
      <% } else { %>
        <p class="small-text">No hay mensajes.</p>
      <% } %>
    </div>
  </div>

  <script>
    function setupMultipleUpload(inputId, hiddenId, statusId) {
      const input = document.getElementById(inputId);
      if (!input) return;

      input.addEventListener('change', async function() {
        const files = Array.from(this.files);
        if (files.length === 0) return;

        const statusDiv = document.getElementById(statusId);
        const hiddenInput = document.getElementById(hiddenId);
        
        let uploadedList = [];
        
        // Validaci√≥n de tama√±o
        for (let f of files) {
           const isVideo = f.type.startsWith('video/');
           const limit = isVideo ? 100 * 1024 * 1024 : 10 * 1024 * 1024;
           if (f.size > limit) {
             alert(`El archivo ${f.name} supera el l√≠mite.`);
             this.value = ''; return;
           }
        }

        try {
          // Obtener firma
          const resSig = await fetch('/sistemas/tickets/signature');
          if (!resSig.ok) throw new Error('Error obteniendo firma');
          const sig = await resSig.json();

          let count = 0;
          statusDiv.innerHTML = `<span style="color:#e67e22">‚è≥ Subiendo 0 / ${files.length}...</span>`;

          for (let file of files) {
             const formData = new FormData();
             formData.append('file', file);
             formData.append('api_key', sig.apiKey);
             formData.append('timestamp', sig.timestamp);
             formData.append('signature', sig.signature);
             formData.append('folder', sig.folder);

             // === L√ìGICA CORREGIDA DE CLASIFICACI√ìN ===
             let type = 'raw';   // Tipo para Cloudinary API
             let dbType = 'doc'; // Tipo para nuestra BD

             if (file.type.startsWith('video/')) {
                type = 'video'; 
                dbType = 'video';
             } else if (file.type.startsWith('image/')) {
                type = 'image'; 
                dbType = 'image'; // <--- ESTO FALTABA
             } else if (file.type === 'application/pdf') {
                type = 'image'; // Cloudinary trata PDF como imagen para thumbnails
                dbType = 'pdf'; 
             } else {
                type = 'raw'; 
                dbType = 'doc';
             }

             const uploadUrl = `https://api.cloudinary.com/v1_1/${sig.cloudName}/${type}/upload`;
             
             const resUp = await fetch(uploadUrl, { method: 'POST', body: formData });
             if (!resUp.ok) throw new Error('Fallo subida ' + file.name);
             const data = await resUp.json();

             uploadedList.push({
                url: data.secure_url,
                nombre: file.name,
                tipo: dbType
             });

             count++;
             statusDiv.innerHTML = `<span style="color:#e67e22">‚è≥ Subiendo ${count} / ${files.length}...</span>`;
          }

          hiddenInput.value = JSON.stringify(uploadedList);
          statusDiv.innerHTML = `<span style="color:green">‚úÖ ${uploadedList.length} archivos listos.</span>`;

        } catch (err) {
          console.error(err);
          statusDiv.innerHTML = `<span style="color:red">‚ùå Error. Intenta de nuevo.</span>`;
          this.value = '';
        }
      });
    }

    setupMultipleUpload('fileAdmin', 'admin_adjuntos_data', 'statusAdmin');
    setupMultipleUpload('fileUser', 'user_adjuntos_data', 'statusUser');
  </script>

</body>
</html>