<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title><%= titulo %></title>
  <link rel="stylesheet" href="/css/styles.css" />
  <style>
    /* ESTILOS PARA ADJUNTOS */
    .adjuntos-container { margin-top: 15px; }
    
    /* Grilla para Im√°genes y Videos (C√≠rculos para img, Cuadrados para video) */
    .grid-media { 
        display: flex; 
        gap: 15px; 
        flex-wrap: wrap; 
        margin-bottom: 15px; 
    }
    
    .media-item {
        width: 120px;
        height: 120px;
        position: relative;
        border-radius: 50%; /* Por defecto redondo para im√°genes */
        overflow: hidden;
        border: 3px solid #eee;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        transition: transform 0.2s;
        background: #f0f0f0;
    }
    .media-item:hover { transform: scale(1.05); border-color: #003a70; }
    
    .media-item img { width: 100%; height: 100%; object-fit: cover; }
    
    /* Estilo espec√≠fico para Videos (Cuadrados con bordes redondeados) */
    .media-item.is-video {
        width: 200px; /* M√°s ancho */
        height: 120px;
        border-radius: 8px; /* Cuadrado redondeado */
        background: #000;
        display: flex; align-items: center; justify-content: center;
    }
    .media-item.is-video video { width: 100%; height: 100%; object-fit: cover; }

    /* Lista para Documentos (PDF, DOC) */
    .list-docs { display: flex; flex-direction: column; gap: 8px; margin-bottom: 15px; }
    .doc-item {
        background: #f8f9fa;
        padding: 8px 12px;
        border-radius: 4px;
        border-left: 4px solid #003a70;
        display: flex; align-items: center; gap: 8px;
        font-size: 0.9rem;
    }
    .doc-item a { text-decoration: none; color: #003a70; font-weight: bold; }
    .doc-item a:hover { text-decoration: underline; }

    /* Estilos etiquetas */
    .label-adjunto { font-size: 0.8rem; font-weight: bold; color: #666; margin-bottom: 5px; display: block; }
  </style>
</head>

<body class="intranet-body">

  <div class="contenedor pagina-ticket-detalle">
    <a class="link-volver" href="/sistemas/tickets">‚Üê Volver al listado de tickets</a>
    <h2 class="page-title">Ticket #<%= ticket.id %></h2>

    <dl class="ticket-detalle">
      <dt>T√≠tulo</dt> <dd><%= ticket.titulo %></dd>
      <dt>Descripci√≥n</dt> <dd><pre class="ticket-descripcion"><%= ticket.descripcion %></pre></dd>
      <dt>Solicitante</dt> <dd><%= ticket.solicitante_nombre || '-' %> &lt;<%= ticket.solicitante_email %>&gt;</dd>
      <dt>Estado</dt> <dd><span class="badge badge-amarilla"><%= ticket.estado %></span></dd>
    </dl>

    <% 
       const canManage = (user.role === 'admin');
       const isOwner = (ticket.solicitante_email === user.email);
    %>

    <% if (canManage) { %>
      <div class="panel panel-actualizar-ticket">
        <h3 class="panel-title">Gestionar Ticket</h3>
        <form id="formAdmin" action="/sistemas/tickets/<%= ticket.id %>/actualizar" method="POST" class="form-actualizar-ticket">
          <label>Estado</label>
          <select name="estado">
             <option value="Abierto" <%= ticket.estado==='Abierto'?'selected':'' %>>Abierto</option>
             <option value="Resuelto" <%= ticket.estado==='Resuelto'?'selected':'' %>>Resuelto</option>
             <option value="Cerrado" <%= ticket.estado==='Cerrado'?'selected':'' %>>Cerrado</option>
          </select>

          <label style="margin-top:15px;">Mensaje (Opcional)</label>
          <textarea name="mensaje_respuesta" rows="4" style="resize:vertical; max-height:400px;"></textarea>

          <input type="hidden" name="adjuntos_data" id="admin_adjuntos_data" value="[]">

          <div style="margin-top: 10px;">
             <input type="file" id="fileAdmin" multiple accept="image/*,video/*,.pdf,.doc,.docx" style="display: none;">
             <button type="button" class="btn btn-primario" onclick="document.getElementById('fileAdmin').click()">üìé Adjuntar archivos (M√∫ltiple)</button>
             <div id="statusAdmin" class="small-text" style="margin-top: 5px;"></div>
          </div>

          <button type="submit" class="btn btn-primario" style="margin-top: 15px; background-color: #002a52;">Actualizar ticket</button>
        </form>
      </div>
    <% } %>

    <% if ( (canManage || isOwner) && ticket.estado !== 'Cerrado' ) { %>
      <div class="panel panel-responder">
        <h3 class="panel-title">Agregar mensaje</h3>
        <form id="formUser" action="/sistemas/tickets/<%= ticket.id %>/responder" method="POST" class="form-responder-ticket">
          <textarea name="mensaje_respuesta" rows="4" placeholder="Escribe tu respuesta..." style="resize:vertical; max-height:400px;"></textarea>

          <input type="hidden" name="adjuntos_data" id="user_adjuntos_data" value="[]">

          <div style="margin-top: 10px;">
             <input type="file" id="fileUser" multiple accept="image/*,video/*,.pdf,.doc,.docx" style="display: none;">
             <button type="button" class="btn btn-primario" onclick="document.getElementById('fileUser').click()">üìé Adjuntar archivos (M√∫ltiple)</button>
             <div id="statusUser" class="small-text" style="margin-top: 5px;"></div>
          </div>

          <button type="submit" class="btn btn-primario" style="margin-top: 15px;">Enviar mensaje</button>
        </form>
      </div>
    <% } %>

    <div class="panel panel-historial">
      <h3 class="panel-title">Historial de comunicaci√≥n</h3>
      <% if (respuestas && respuestas.length > 0) { %>
        <% respuestas.forEach(r => { %>
          <div class="respuesta-item">
            <div class="respuesta-header">
              <strong class="respuesta-remitente"><%= r.remitente %></strong>
              <span class="small-text"><%= r.fecha ? new Date(r.fecha).toLocaleString('es-CL') : '' %></span>
            </div>
            <pre class="respuesta-mensaje"><%= r.mensaje %></pre>
            
            <% 
               let archivos = [];
               // 1. Intentamos leer la columna nueva JSON
               if (r.adjuntos) {
                 try { archivos = JSON.parse(r.adjuntos); } catch(e){}
               } 
               // 2. Si no hay JSON, miramos si hay archivo legacy (antiguo)
               else if (r.archivo_url) {
                 archivos.push({
                   url: r.archivo_url,
                   nombre: r.archivo_nombre || 'Adjunto',
                   tipo: r.archivo_tipo || 'image'
                 });
               }

               // 3. Separar por tipos
               let imagenes = archivos.filter(a => a.tipo === 'image');
               let videos   = archivos.filter(a => a.tipo === 'video');
               let docs     = archivos.filter(a => a.tipo !== 'image' && a.tipo !== 'video');
            %>

            <div class="adjuntos-container">
              
              <% if (imagenes.length > 0) { %>
                <span class="label-adjunto">üìé Im√°genes adjuntas:</span>
                <div class="grid-media">
                  <% imagenes.forEach(img => { %>
                    <a href="<%= img.url %>" target="_blank" class="media-item">
                       <img src="<%= img.url %>" title="<%= img.nombre %>">
                    </a>
                  <% }) %>
                </div>
              <% } %>

              <% if (docs.length > 0) { %>
                <span class="label-adjunto">üìé Documentos:</span>
                <div class="list-docs">
                  <% docs.forEach(doc => { %>
                    <div class="doc-item">
                      üìÑ <a href="<%= doc.url %>" target="_blank"><%= doc.nombre %></a>
                    </div>
                  <% }) %>
                </div>
              <% } %>

              <% if (videos.length > 0) { %>
                <span class="label-adjunto">üìé Videos adjuntos:</span>
                <div class="grid-media">
                  <% videos.forEach(vid => { %>
                     <div class="media-item is-video">
                        <video src="<%= vid.url %>" controls></video>
                     </div>
                  <% }) %>
                </div>
              <% } %>

            </div>
          </div>
        <% }) %>
      <% } else { %>
        <p class="small-text">No hay mensajes.</p>
      <% } %>
    </div>
  </div>

  <script>
    // Script unificado para manejar m√∫ltiples archivos
    function setupMultipleUpload(inputId, hiddenId, statusId) {
      const input = document.getElementById(inputId);
      if (!input) return;

      input.addEventListener('change', async function() {
        const files = Array.from(this.files);
        if (files.length === 0) return;

        const statusDiv = document.getElementById(statusId);
        const hiddenInput = document.getElementById(hiddenId);
        
        let uploadedList = [];
        
        // Validar tama√±os antes de empezar
        for (let f of files) {
           const isVideo = f.type.startsWith('video/');
           const limit = isVideo ? 100 * 1024 * 1024 : 10 * 1024 * 1024;
           if (f.size > limit) {
             alert(`El archivo ${f.name} pesa demasiado.`);
             this.value = ''; return;
           }
        }

        try {
          // Obtener firma UNA vez (o por cada uno, cloudinary a veces prefiere por archivo si cambia timestamp, pero usualmente 1 sirve si es r√°pido)
          // Para seguridad, pediremos firma dentro del loop o una general. Usaremos una general.
          const resSig = await fetch('/sistemas/tickets/signature');
          if (!resSig.ok) throw new Error('Error firma');
          const sig = await resSig.json();

          let count = 0;
          statusDiv.innerHTML = `<span style="color:#e67e22">‚è≥ Subiendo 0 / ${files.length}...</span>`;

          for (let file of files) {
             const formData = new FormData();
             formData.append('file', file);
             formData.append('api_key', sig.apiKey);
             formData.append('timestamp', sig.timestamp);
             formData.append('signature', sig.signature);
             formData.append('folder', sig.folder);

             let type = 'image'; // Cloudinary resource type
             let dbType = 'image'; // Nuestro tipo DB

             if (file.type.startsWith('video/')) {
                type = 'video'; dbType = 'video';
             } else if (file.type === 'application/pdf') {
                type = 'image'; dbType = 'pdf'; // Cloudinary acepta PDF como image para preview
             } else {
                type = 'raw'; dbType = 'doc'; // Word, Excel, etc
             }

             const uploadUrl = `https://api.cloudinary.com/v1_1/${sig.cloudName}/${type}/upload`;
             
             const resUp = await fetch(uploadUrl, { method: 'POST', body: formData });
             if (!resUp.ok) throw new Error('Fallo subida ' + file.name);
             const data = await resUp.json();

             uploadedList.push({
                url: data.secure_url,
                nombre: file.name,
                tipo: dbType
             });

             count++;
             statusDiv.innerHTML = `<span style="color:#e67e22">‚è≥ Subiendo ${count} / ${files.length}...</span>`;
          }

          // Guardar JSON en input oculto
          hiddenInput.value = JSON.stringify(uploadedList);
          
          statusDiv.innerHTML = `<span style="color:green">‚úÖ Listos ${uploadedList.length} archivos para enviar.</span>`;

        } catch (err) {
          console.error(err);
          statusDiv.innerHTML = `<span style="color:red">‚ùå Error subiendo archivos. Intenta de nuevo.</span>`;
          this.value = '';
        }
      });
    }

    setupMultipleUpload('fileAdmin', 'admin_adjuntos_data', 'statusAdmin');
    setupMultipleUpload('fileUser', 'user_adjuntos_data', 'statusUser');
  </script>

</body>
</html>