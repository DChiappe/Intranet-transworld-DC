<div class="contenedor">
  <h2 class="page-title">Reglamento interno</h2>
  <p class="page-description">
    Normativa, pol√≠ticas internas y documentos oficiales de la empresa.
  </p>

  <% const canWrite = (typeof can !== 'undefined' && can.reglamento_write); %>

  <% if (canWrite) { %>
    <div class="panel">
      <h3 class="panel-title">Subir reglamento / documento interno</h3>

      <form action="/procesos/reglamento/subir" method="POST" enctype="multipart/form-data" class="form-ticket">
        <label style="font-weight: bold; display: block; margin-bottom: 5px;">Nombre del documento</label>
        <input type="text" name="nombre_archivo" placeholder="Ej: Reglamento Interno 2024" required 
               style="width: 100%; padding: 8px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 4px;">

        <label style="font-weight: bold; display: block; margin-bottom: 5px;">Archivo</label>
        <input type="file" name="archivo" required style="margin-bottom: 10px;" accept=".pdf,.doc,.docx">
        
        <button type="submit" class="btn btn-primario">Subir archivo</button>
      </form>
    </div>
  <% } %>

  <div class="panel" style="margin-top: 18px;">
    <h3 class="panel-title">Archivos disponibles</h3>

    <% if (!archivos || archivos.length === 0) { %>
      <p class="no-data">No hay archivos cargados en esta secci√≥n.</p>
    <% } else { %>
      
      <div class="grid-archivos">
        <% archivos.forEach(function(archivo) { %>
          <% 
             let thumbUrl = archivo.url;
             if (archivo.format === 'pdf' || archivo.url.endsWith('.pdf')) {
                if (archivo.url.includes('/upload/')) {
                    thumbUrl = archivo.url.replace(/\.pdf$/, '.jpg');
                }
             } else if (archivo.format === 'doc' || archivo.format === 'docx') {
                thumbUrl = '/img/doc-placeholder.png'; 
             }
          %>
          
          <div class="card-archivo">
            <div class="preview-container" onclick="abrirModal('<%= archivo.url %>', '<%= archivo.name %>')">
              <img 
                src="<%= thumbUrl %>" 
                alt="Vista previa" 
                class="preview-img"
                onerror="this.src='https://via.placeholder.com/300x200?text=Documento'"
              >
              <div class="icon-fallback" style="display: none;">üìÑ</div>
            </div>

            <div class="card-body">
              <h4 class="card-title" title="<%= archivo.name %>"><%= archivo.name %></h4>
              
              <div class="card-actions" style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                <a href="<%= archivo.url %>" target="_blank" download class="btn-secundario" style="font-size: 0.8rem; padding: 4px 8px;">
                  ‚¨á Descargar
                </a>

                <% if (canWrite) { %>
                  <div style="display: flex; gap: 8px;">
                    
                    <button type="button" onclick="abrirModalEditar('<%= archivo.id %>', '<%= archivo.name %>')" 
                            style="background:none; border:none; cursor:pointer; font-size:1.2rem;" title="Editar Nombre">
                      ‚úèÔ∏è
                    </button>

                    <form action="/procesos/reglamento/eliminar" method="POST" onsubmit="return confirm('¬øEliminar este archivo?');" style="margin:0;">
                      <input type="hidden" name="public_id" value="<%= archivo.public_id %>">
                      <input type="hidden" name="db_id" value="<%= archivo.id %>">
                      <button type="submit" style="background:none; border:none; cursor:pointer; font-size:1.2rem;" title="Eliminar">
                        üóëÔ∏è
                      </button>
                    </form>
                  </div>
                <% } %>
              </div>
            </div>
          </div>
        <% }) %>
      </div>
    <% } %>

    <% if (!canWrite) { %>
      <p class="small-text" style="margin-top:10px; color: #666;">
        Tienes acceso de solo lectura en esta secci√≥n.
      </p>
    <% } %>
  </div>

  <div class="grid-opciones" style="margin-top: 25px;">
    <a class="boton-opcion" href="/procesos">
      Volver a Procesos y Documentos
      <span>Regresar al men√∫ principal de documentos.</span>
    </a>
  </div>
</div>

<div id="pdfModal" class="modal-overlay" onclick="cerrarModal(event)">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="modalTitle" style="margin:0; font-size:1.1rem;">Visualizador</h3>
      <span class="modal-close" onclick="cerrarModal()">&times;</span>
    </div>
    <iframe id="pdfFrame" class="pdf-frame" src=""></iframe>
  </div>
</div>

<div id="editModal" class="modal-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000;">
  <div class="modal-content" style="max-width: 400px; margin: 100px auto; background: white; padding: 20px; border-radius: 8px;">
    <h3 style="margin-top: 0;">Editar Nombre</h3>
    
    <form action="/procesos/documento/editar" method="POST">
      <input type="hidden" name="return_to" value="/procesos/reglamento">
      <input type="hidden" id="edit_id" name="id">
      
      <label style="display:block; margin-bottom: 5px;">Nuevo Nombre:</label>
      <input type="text" id="edit_nombre" name="nuevo_nombre" required style="width: 100%; padding: 8px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 4px;">
      
      <div style="text-align: right;">
        <button type="button" onclick="document.getElementById('editModal').style.display='none'" style="padding: 8px 15px; background: #ccc; border: none; border-radius: 4px; cursor: pointer; margin-right: 5px;">Cancelar</button>
        <button type="submit" class="btn btn-primario" style="padding: 8px 15px;">Guardar</button>
      </div>
    </form>
  </div>
</div>

<script>
  function abrirModal(url, nombre) {
    const modal = document.getElementById('pdfModal');
    const iframe = document.getElementById('pdfFrame');
    const title = document.getElementById('modalTitle');
    iframe.src = 'https://docs.google.com/gview?url=' + encodeURIComponent(url) + '&embedded=true';
    title.innerText = nombre || 'Documento';
    modal.style.display = 'block';
  }
  function cerrarModal(event) {
    if (event && event.target !== document.getElementById('pdfModal') && event.target.className !== 'modal-close') return;
    document.getElementById('pdfModal').style.display = 'none';
    document.getElementById('pdfFrame').src = '';
  }

  function abrirModalEditar(id, nombreActual) {
    document.getElementById('edit_id').value = id;
    document.getElementById('edit_nombre').value = nombreActual;
    document.getElementById('editModal').style.display = 'block';
  }
</script>

<script>
(function () {
  const form = document.querySelector('form.form-ticket');
  if (!form) return;

  const tipo = location.pathname.split('/').pop();
  const fileInput = form.querySelector('input[type="file"]');
  const nameInput = form.querySelector('input[name="nombre_archivo"]');

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const file = fileInput.files[0];
    if (!file) return alert('Selecciona un archivo');

    if (file.size > 10 * 1024 * 1024) {
      return alert('El archivo supera los 10 MB permitidos.');
    }

    try {
      // 1Ô∏è‚É£ Obtener signature
      const sigRes = await fetch(`/procesos/${tipo}/signature`);
      const sig = await sigRes.json();

      // 2Ô∏è‚É£ Subir DIRECTO a Cloudinary (RAW)
      const fd = new FormData();
      fd.append('file', file);
      fd.append('api_key', sig.apiKey);
      fd.append('timestamp', sig.timestamp);
      fd.append('signature', sig.signature);
      fd.append('folder', sig.folder);
      fd.append('resource_type', 'raw');

      const uploadRes = await fetch(
        `https://api.cloudinary.com/v1_1/${sig.cloudName}/raw/upload`,
        { method: 'POST', body: fd }
      );

      const data = await uploadRes.json();
      if (!data.secure_url) throw new Error('Error subiendo a Cloudinary');

      // 3Ô∏è‚É£ Registrar en tu sistema
      const saveRes = await fetch(`/procesos/${tipo}/subir`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          nombre_archivo: nameInput.value,
          secure_url: data.secure_url,
          public_id: data.public_id
        })
      });

      if (!saveRes.ok) throw new Error('Error guardando documento');

      location.reload();
    } catch (err) {
      console.error(err);
      alert(err.message || 'Error subiendo documento');
    }
  });
})();
</script>
