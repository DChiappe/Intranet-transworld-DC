<div class="contenedor">
  <h2 class="page-title">Procedimientos</h2>
  <p class="page-description">
    Aqu√≠ encontrar√°s los procedimientos operativos documentados para las tareas del d√≠a a d√≠a.
  </p>

  <% const canWrite = (typeof can !== 'undefined' && can.procedimientos_write); %>

  <% if (canWrite) { %>
    <div class="panel">
      <h3 class="panel-title">Subir nuevo procedimiento</h3>

      <form id="uploadDocForm" action="/procesos/procedimientos/subir" method="POST" enctype="multipart/form-data" class="form-ticket">
        <label style="font-weight: bold; display: block; margin-bottom: 5px;">Nombre del documento</label>
        <input
          type="text"
          name="nombre_archivo"
          placeholder="Ej: Procedimiento de Bodega"
          required
          style="width: 100%; padding: 8px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 4px;"
        >

        <label style="font-weight: bold; display: block; margin-bottom: 5px;">Archivo</label>
        <input
          type="file"
          name="archivo"
          required
          style="margin-bottom: 10px;"
          accept=".pdf,.doc,.docx"
        >

        <div id="uploadStatus" style="margin: 10px 0 0; font-size: 0.95rem; color: #555; display:none;"></div>

        <button type="submit" class="btn btn-primario" id="btnUploadDoc">Subir archivo</button>

        <small style="display:block; margin-top:10px; color:#666;">
          Nota: En Cloudinary Free, el l√≠mite t√≠pico por archivo es 10MB.
        </small>
      </form>
    </div>
  <% } %>

  <div class="panel" style="margin-top: 18px;">
    <h3 class="panel-title">Archivos disponibles</h3>

    <% if (!archivos || archivos.length === 0) { %>
      <p class="no-data">No hay archivos cargados en esta secci√≥n.</p>
    <% } else { %>

      <div class="grid-archivos">
        <% archivos.forEach(function(archivo) { %>
          <%
            var url = (archivo.url || '');
            var ext = (archivo.format || '').toLowerCase();
            var urlLower = url.toLowerCase();

            var isPdf = (ext === 'pdf') || urlLower.endsWith('.pdf');
            var isDoc = (ext === 'doc' || ext === 'docx') || urlLower.endsWith('.doc') || urlLower.endsWith('.docx');
            var badge = isPdf ? 'PDF' : (isDoc ? 'DOC' : '');
            if (isDoc && (ext === 'docx' || urlLower.endsWith('.docx'))) badge = 'DOCX';

            // Si alg√∫n d√≠a guardas im√°genes en esta tabla:
            var isImg = urlLower.endsWith('.png') || urlLower.endsWith('.jpg') || urlLower.endsWith('.jpeg') || urlLower.endsWith('.webp') || urlLower.endsWith('.gif');
          %>

          <div class="card-archivo">
            <div class="preview-container" onclick="abrirModal('<%= archivo.url %>', '<%= archivo.name %>')">
              <% if (isPdf || isDoc) { %>
                <div class="doc-preview <%= isPdf ? 'doc-preview--pdf' : 'doc-preview--doc' %>">
                  <div class="doc-badge"><%= badge %></div>

                  <div class="doc-icon" aria-hidden="true">
                    <!-- Icono inline (no depende de archivos externos) -->
                    <svg viewBox="0 0 24 24" width="54" height="54" fill="none">
                      <path d="M7 3h7l3 3v15a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1Z" stroke="currentColor" stroke-width="1.6"/>
                      <path d="M14 3v3a1 1 0 0 0 1 1h3" stroke="currentColor" stroke-width="1.6"/>
                      <path d="M8 16h8M8 13h8M8 10h5" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
                    </svg>
                  </div>

                  <div class="doc-hint">Ver documento</div>
                </div>
              <% } else { %>
                <!-- Para im√°genes reales, mostramos thumbnail -->
                <img
                  src="<%= archivo.url %>"
                  alt="<%= archivo.name %>"
                  class="preview-img"
                  loading="lazy"
                  onerror="this.onerror=null; this.style.display='none'; this.parentElement.querySelector('.doc-fallback').style.display='flex';"
                />
                <!-- Fallback elegante si no es imagen -->
                <div class="doc-preview doc-fallback" style="display:none;">
                  <div class="doc-badge">ARCHIVO</div>
                  <div class="doc-icon" aria-hidden="true">
                    <svg viewBox="0 0 24 24" width="54" height="54" fill="none">
                      <path d="M7 3h7l3 3v15a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1Z" stroke="currentColor" stroke-width="1.6"/>
                      <path d="M14 3v3a1 1 0 0 0 1 1h3" stroke="currentColor" stroke-width="1.6"/>
                    </svg>
                  </div>
                  <div class="doc-hint">Ver archivo</div>
                </div>
              <% } %>
            </div>

            <div class="card-body">
              <h4 class="card-title" title="<%= archivo.name %>"><%= archivo.name %></h4>

              <div class="card-actions" style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                <a href="<%= archivo.url %>" target="_blank" download class="btn-secundario" style="font-size: 0.8rem; padding: 4px 8px;">
                  ‚¨á Descargar
                </a>

                <% if (canWrite) { %>
                  <div style="display: flex; gap: 8px;">
                    <button
                      type="button"
                      onclick="abrirModalEditar('<%= archivo.id %>', '<%= archivo.name %>')"
                      style="background:none; border:none; cursor:pointer; font-size:1.2rem;"
                      title="Editar Nombre"
                    >
                      ‚úèÔ∏è
                    </button>

                    <form action="/procesos/procedimientos/eliminar" method="POST" onsubmit="return confirm('¬øEliminar este archivo?');" style="margin:0;">
                      <input type="hidden" name="public_id" value="<%= archivo.public_id %>">
                      <input type="hidden" name="db_id" value="<%= archivo.id %>">
                      <button type="submit" style="background:none; border:none; cursor:pointer; font-size:1.2rem;" title="Eliminar">
                        üóëÔ∏è
                      </button>
                    </form>
                  </div>
                <% } %>
              </div>
            </div>
          </div>
        <% }) %>
      </div>
    <% } %>
  </div>
</div>

<!-- Modal visor -->
<div id="pdfModal" class="modal-overlay" onclick="cerrarModal(event)">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="modalTitle" style="margin:0; font-size:1.1rem;">Visualizador</h3>
      <span class="modal-close" onclick="cerrarModal()">&times;</span>
    </div>
    <iframe id="pdfFrame" class="pdf-frame" src=""></iframe>
  </div>
</div>

<!-- Modal editar -->
<div id="editModal" class="modal-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000;">
  <div class="modal-content" style="max-width: 400px; margin: 100px auto; background: white; padding: 20px; border-radius: 8px;">
    <h3 style="margin-top: 0;">Editar Nombre del Documento</h3>

    <form action="/procesos/documento/editar" method="POST">
      <input type="hidden" name="return_to" value="/procesos/procedimientos">
      <input type="hidden" id="edit_id" name="id">

      <label style="display:block; margin-bottom: 5px;">Nuevo Nombre:</label>
      <input type="text" id="edit_nombre" name="nuevo_nombre" required style="width: 100%; padding: 8px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 4px;">

      <div style="text-align: right;">
        <button type="button" onclick="document.getElementById('editModal').style.display='none'" style="padding: 8px 15px; background: #ccc; border: none; border-radius: 4px; cursor: pointer; margin-right: 5px;">Cancelar</button>
        <button type="submit" class="btn btn-primario" style="padding: 8px 15px;">Guardar</button>
      </div>
    </form>
  </div>
</div>

<style>
  /* Preview bonito para PDF/DOC */
  .preview-container{
    border-radius: 10px;
    overflow: hidden;
    cursor: pointer;
  }
  .preview-img{
    width: 100%;
    height: 180px;
    object-fit: cover;
    display: block;
  }
  .doc-preview{
    height: 180px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    gap: 10px;
    position: relative;
    background: #f5f7fa;
    border: 1px solid rgba(0,0,0,0.06);
  }
  .doc-preview--pdf{
    color: #b42318;
    background: linear-gradient(180deg, #fff5f5 0%, #f5f7fa 100%);
  }
  .doc-preview--doc{
    color: #175cd3;
    background: linear-gradient(180deg, #eef4ff 0%, #f5f7fa 100%);
  }
  .doc-badge{
    position: absolute;
    top: 10px;
    left: 10px;
    font-size: 0.75rem;
    font-weight: 700;
    letter-spacing: 0.5px;
    padding: 4px 8px;
    border-radius: 999px;
    background: rgba(255,255,255,0.9);
    border: 1px solid rgba(0,0,0,0.08);
  }
  .doc-icon{ line-height: 0; opacity: 0.95; }
  .doc-hint{ font-size: 0.9rem; color: rgba(0,0,0,0.65); }
</style>

<script>
  // Visor (mantiene tu l√≥gica con Google Viewer)
  function abrirModal(url, nombre) {
    const modal = document.getElementById('pdfModal');
    const iframe = document.getElementById('pdfFrame');
    const title = document.getElementById('modalTitle');

    iframe.src = 'https://docs.google.com/gview?url=' + encodeURIComponent(url) + '&embedded=true';
    title.innerText = nombre || 'Documento';
    modal.style.display = 'block';
  }

  function cerrarModal(event) {
    if (event && event.target !== document.getElementById('pdfModal') && event.target.className !== 'modal-close') return;
    document.getElementById('pdfModal').style.display = 'none';
    document.getElementById('pdfFrame').src = '';
  }

  function abrirModalEditar(id, nombreActual) {
    document.getElementById('edit_id').value = id;
    document.getElementById('edit_nombre').value = nombreActual;
    document.getElementById('editModal').style.display = 'block';
  }
</script>

<script>
  // Subida DIRECTA a Cloudinary (RAW) + registro en tu backend
  (function () {
    const form = document.getElementById('uploadDocForm');
    if (!form) return;

    const fileInput = form.querySelector('input[name="archivo"]');
    const nameInput = form.querySelector('input[name="nombre_archivo"]');
    const btn = document.getElementById('btnUploadDoc');
    const statusEl = document.getElementById('uploadStatus');

    function setStatus(msg, show) {
      statusEl.textContent = msg || '';
      statusEl.style.display = show ? 'block' : 'none';
    }

    function setBusy(busy) {
      if (btn) btn.disabled = busy;
      if (fileInput) fileInput.disabled = busy;
      if (nameInput) nameInput.disabled = busy;
      if (btn) btn.textContent = busy ? 'Subiendo...' : 'Subir archivo';
    }

    function withTimeout(ms) {
      const controller = new AbortController();
      const t = setTimeout(() => controller.abort(), ms);
      return { controller, clear: () => clearTimeout(t) };
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const file = fileInput?.files?.[0];
      if (!file) return alert('Selecciona un archivo.');

      // Cloudinary Free: l√≠mite t√≠pico 10MB para RAW
      if (file.size > 10 * 1024 * 1024) {
        return alert('El archivo supera los 10 MB permitidos.');
      }

      try {
        setBusy(true);
        setStatus('Obteniendo autorizaci√≥n...', true);

        // 1) Signature
        const sigTO = withTimeout(15000);
        const sigRes = await fetch('/procesos/procedimientos/signature', {
          method: 'GET',
          headers: { 'Accept': 'application/json' },
          signal: sigTO.controller.signal
        });
        sigTO.clear();

        if (!sigRes.ok) {
          const txt = await sigRes.text().catch(() => '');
          throw new Error(`No se pudo obtener la firma (HTTP ${sigRes.status}). ${txt ? 'Detalle: ' + txt : ''}`);
        }

        const sig = await sigRes.json();
        if (!sig.cloudName || !sig.apiKey || !sig.signature || !sig.timestamp || !sig.folder) {
          throw new Error('Signature inv√°lida. Revisa variables de Cloudinary en Render.');
        }

        // 2) Upload a Cloudinary RAW
        setStatus('Subiendo a la nube...', true);
        const uploadUrl = `https://api.cloudinary.com/v1_1/${encodeURIComponent(sig.cloudName)}/raw/upload`;

        const fd = new FormData();
        fd.append('file', file);
        fd.append('api_key', sig.apiKey);
        fd.append('timestamp', String(sig.timestamp));
        fd.append('signature', sig.signature);
        fd.append('folder', sig.folder);

        const upTO = withTimeout(120000);
        const uploadRes = await fetch(uploadUrl, {
          method: 'POST',
          body: fd,
          signal: upTO.controller.signal
        });
        upTO.clear();

        const uploadData = await uploadRes.json().catch(() => ({}));
        if (!uploadRes.ok || !uploadData.secure_url) {
          const msg = uploadData?.error?.message || 'Cloudinary rechaz√≥ el archivo.';
          throw new Error(msg);
        }

        // 3) Registrar en tu BD
        setStatus('Registrando en el sistema...', true);
        const saveTO = withTimeout(20000);
        const saveRes = await fetch('/procesos/procedimientos/subir', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
          body: JSON.stringify({
            nombre_archivo: nameInput?.value || file.name,
            secure_url: uploadData.secure_url,
            public_id: uploadData.public_id
          }),
          signal: saveTO.controller.signal
        });
        saveTO.clear();

        if (!saveRes.ok) {
          const txt = await saveRes.text().catch(() => '');
          throw new Error(`Error guardando en BD (HTTP ${saveRes.status}). ${txt ? 'Detalle: ' + txt : ''}`);
        }

        setStatus('Listo. Actualizando...', true);
        location.reload();
      } catch (err) {
        console.error(err);
        alert(err.name === 'AbortError'
          ? 'La subida tard√≥ demasiado y se cancel√≥. Intenta de nuevo.'
          : (err.message || 'Error subiendo documento.')
        );
        setStatus('', false);
        setBusy(false);
      }
    });
  })();
</script>
