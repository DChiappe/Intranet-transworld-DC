<div class="contenedor">
  <h2 class="page-title">Procedimientos</h2>
  <p class="page-description">
    Aqu√≠ encontrar√°s los procedimientos operativos documentados para las tareas del d√≠a a d√≠a.
  </p>

  <% const canWrite = (typeof can !== 'undefined' && can.procedimientos_write); %>

  <% if (canWrite) { %>
    <div class="panel">
      <h3 class="panel-title">Subir nuevo procedimiento</h3>

      <form action="/procesos/procedimientos/subir" method="POST" enctype="multipart/form-data" class="form-ticket">
        <label style="font-weight: bold; display: block; margin-bottom: 5px;">Nombre del documento</label>
        <input type="text" name="nombre_archivo" placeholder="Ej: Procedimiento de Bodega" required 
               style="width: 100%; padding: 8px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 4px;">

        <label style="font-weight: bold; display: block; margin-bottom: 5px;">Archivo</label>
        <input type="file" name="archivo" required style="margin-bottom: 10px;" accept=".pdf,.doc,.docx">
        
        <button type="submit" class="btn btn-primario">Subir archivo</button>
      </form>
    </div>
  <% } %>

  <div class="panel" style="margin-top: 18px;">
    <h3 class="panel-title">Archivos disponibles</h3>

    <% if (!archivos || archivos.length === 0) { %>
      <p class="no-data">No hay archivos cargados en esta secci√≥n.</p>
    <% } else { %>
      
      <div class="grid-archivos">
        <% archivos.forEach(function(archivo) { %>
          <% 
             let thumbUrl = archivo.url;
             if (archivo.format === 'pdf' || archivo.url.endsWith('.pdf')) {
                // Generar thumbnail jpg si es pdf (truco cloudinary)
                if (archivo.url.includes('/upload/')) {
                    thumbUrl = archivo.url.replace(/\.pdf$/, '.jpg');
                }
             } else if (archivo.format === 'doc' || archivo.format === 'docx') {
                thumbUrl = '/img/doc-placeholder.png'; // Opcional: √≠cono gen√©rico
             }
          %>
          
          <div class="card-archivo">
            <div class="preview-container" onclick="abrirModal('<%= archivo.url %>', '<%= archivo.name %>')">
              <img src="<%= thumbUrl %>" alt="Doc" class="preview-img" onerror="this.src='https://via.placeholder.com/300x200?text=Documento'">
              <div class="icon-fallback" style="display: none;">üìÑ</div>
            </div>

            <div class="card-body">
              <h4 class="card-title" title="<%= archivo.name %>"><%= archivo.name %></h4>
              
              <div class="card-actions" style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                <a href="<%= archivo.url %>" target="_blank" download class="btn-secundario" style="font-size: 0.8rem; padding: 4px 8px;">
                  ‚¨á Descargar
                </a>

                <% if (canWrite) { %>
                  <div style="display: flex; gap: 8px;">
                    
                    <button type="button" onclick="abrirModalEditar('<%= archivo.id %>', '<%= archivo.name %>')" 
                            style="background:none; border:none; cursor:pointer; font-size:1.2rem;" title="Editar Nombre">
                      ‚úèÔ∏è
                    </button>

                    <form action="/procesos/procedimientos/eliminar" method="POST" onsubmit="return confirm('¬øEliminar este archivo?');" style="margin:0;">
                      <input type="hidden" name="public_id" value="<%= archivo.public_id %>">
                      <input type="hidden" name="db_id" value="<%= archivo.id %>">
                      <button type="submit" style="background:none; border:none; cursor:pointer; font-size:1.2rem;" title="Eliminar">
                        üóëÔ∏è
                      </button>
                    </form>
                  </div>
                <% } %>
              </div>
            </div>
          </div>
        <% }) %>
      </div>
    <% } %>
  </div>
</div>

<div id="pdfModal" class="modal-overlay" onclick="cerrarModal(event)">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="modalTitle" style="margin:0; font-size:1.1rem;">Visualizador</h3>
      <span class="modal-close" onclick="cerrarModal()">&times;</span>
    </div>
    <iframe id="pdfFrame" class="pdf-frame" src=""></iframe>
  </div>
</div>

<div id="editModal" class="modal-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000;">
  <div class="modal-content" style="max-width: 400px; margin: 100px auto; background: white; padding: 20px; border-radius: 8px;">
    <h3 style="margin-top: 0;">Editar Nombre del Documento</h3>
    
    <form action="/procesos/documento/editar" method="POST">
      <input type="hidden" name="return_to" value="/procesos/procedimientos">
      <input type="hidden" id="edit_id" name="id">
      
      <label style="display:block; margin-bottom: 5px;">Nuevo Nombre:</label>
      <input type="text" id="edit_nombre" name="nuevo_nombre" required style="width: 100%; padding: 8px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 4px;">
      
      <div style="text-align: right;">
        <button type="button" onclick="document.getElementById('editModal').style.display='none'" style="padding: 8px 15px; background: #ccc; border: none; border-radius: 4px; cursor: pointer; margin-right: 5px;">Cancelar</button>
        <button type="submit" class="btn btn-primario" style="padding: 8px 15px;">Guardar</button>
      </div>
    </form>
  </div>
</div>

<script>
  // Funciones PDF existentes
  function abrirModal(url, nombre) {
    const modal = document.getElementById('pdfModal');
    const iframe = document.getElementById('pdfFrame');
    const title = document.getElementById('modalTitle');
    iframe.src = 'https://docs.google.com/gview?url=' + encodeURIComponent(url) + '&embedded=true';
    title.innerText = nombre || 'Documento';
    modal.style.display = 'block';
  }
  function cerrarModal(event) {
    if (event && event.target !== document.getElementById('pdfModal') && event.target.className !== 'modal-close') return;
    document.getElementById('pdfModal').style.display = 'none';
    document.getElementById('pdfFrame').src = '';
  }

  // Nueva funci√≥n Editar
  function abrirModalEditar(id, nombreActual) {
    document.getElementById('edit_id').value = id;
    document.getElementById('edit_nombre').value = nombreActual;
    document.getElementById('editModal').style.display = 'block';
  }
</script>