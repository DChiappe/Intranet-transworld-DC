<div class="contenedor">
  <h2 class="page-title">Procedimientos</h2>
  <p class="page-description">
    Aqu√≠ encontrar√°s los procedimientos operativos documentados para las tareas
    del d√≠a a d√≠a dentro de la empresa.
  </p>

  <% const canWrite = (typeof can !== 'undefined' && can.procedimientos_write); %>

  <% if (canWrite) { %>
    <div class="panel">
      <h3 class="panel-title">Subir nuevo procedimiento</h3>

      <form action="/procesos/procedimientos/subir" method="POST" enctype="multipart/form-data" class="form-ticket">
        <input type="file" name="archivo" required style="margin-bottom: 10px;" accept=".pdf,.doc,.docx">
        <button type="submit" class="btn btn-primario">Subir archivo</button>
      </form>

      <p class="small-text" style="margin-top:8px;">
        Sugerencia: usa nombres claros (ej: <em>Procedimiento - Bodega - Recepci√≥n.pdf</em>).
      </p>
    </div>
  <% } %>

  <div class="panel" style="margin-top: 18px;">
    <h3 class="panel-title">Archivos disponibles</h3>

    <% if (!archivos || archivos.length === 0) { %>
      <p class="no-data">No hay archivos cargados en esta secci√≥n.</p>
    <% } else { %>
      
      <div class="grid-archivos">
        <% archivos.forEach(function(archivo) { %>
          <% 
             // L√≥gica para intentar generar miniatura de Cloudinary
             // Si es PDF, intentamos cambiar la extensi√≥n a .jpg para obtener la portada
             let thumbUrl = archivo.url;
             if (archivo.format === 'pdf' || archivo.url.endsWith('.pdf')) {
                // Truco de Cloudinary: si termina en .pdf, lo cambiamos a .jpg para preview
                thumbUrl = archivo.url.substr(0, archivo.url.lastIndexOf('.')) + '.jpg';
             }
          %>
          
          <div class="card-archivo">
            <div class="preview-container" onclick="abrirModal('<%= archivo.url %>', '<%= archivo.name %>')">
              <img 
                src="<%= thumbUrl %>" 
                alt="Vista previa" 
                class="preview-img"
                onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
              >
              <div class="icon-fallback" style="display: none;">
                üìÑ
                <span>Ver PDF</span>
              </div>
            </div>

            <div class="card-body">
              <h4 class="card-title" title="<%= archivo.name %>"><%= archivo.name %></h4>
              
              <div class="card-actions">
                <a href="<%= archivo.url %>" target="_blank" download class="btn-secundario" style="font-size: 0.8rem; padding: 4px 8px;">
                  ‚¨á Descargar
                </a>

                <% if (canWrite) { %>
                  <form
                    action="/procesos/procedimientos/<%= encodeURIComponent(archivo.name) %>/eliminar"
                    method="POST"
                    onsubmit="return confirm('¬øEliminar este archivo?');"
                    style="margin:0;"
                  >
                    <input type="hidden" name="public_id" value="<%= archivo.public_id %>">
                    <button type="submit" style="background:none; border:none; cursor:pointer; font-size:1.1rem;" title="Eliminar">
                      üóëÔ∏è
                    </button>
                  </form>
                <% } %>
              </div>
            </div>
          </div>
        <% }) %>
      </div>

    <% } %>

    <% if (!canWrite) { %>
      <p class="small-text" style="margin-top:10px; color: #666;">
        Tienes acceso de solo lectura en esta secci√≥n.
      </p>
    <% } %>
  </div>

  <div class="grid-opciones" style="margin-top: 25px;">
    <a class="boton-opcion" href="/procesos">
      Volver a Procesos y Documentos
      <span>Regresar al men√∫ principal de documentos.</span>
    </a>
  </div>
</div>

<div id="pdfModal" class="modal-overlay" onclick="cerrarModal(event)">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="modalTitle" style="margin:0; font-size:1.1rem;">Visualizador</h3>
      <span class="modal-close" onclick="cerrarModal()">&times;</span>
    </div>
    <iframe id="pdfFrame" class="pdf-frame" src=""></iframe>
  </div>
</div>

<script>
  function abrirModal(url, nombre) {
    const modal = document.getElementById('pdfModal');
    const iframe = document.getElementById('pdfFrame');
    const title = document.getElementById('modalTitle');
    
    // Asignar URL al iframe
    iframe.src = url;
    title.innerText = nombre || 'Documento';
    
    // Mostrar modal
    modal.style.display = 'block';
    
    // Bloquear scroll del body
    document.body.style.overflow = 'hidden';
  }

  function cerrarModal(event) {
    // Si se pasa evento, verificar que el click fue en el overlay (fuera del contenido)
    if (event && event.target !== document.getElementById('pdfModal') && event.target.className !== 'modal-close') {
      return;
    }

    const modal = document.getElementById('pdfModal');
    const iframe = document.getElementById('pdfFrame');
    
    // Ocultar modal y limpiar src para detener carga/memoria
    modal.style.display = 'none';
    iframe.src = '';
    
    // Restaurar scroll del body
    document.body.style.overflow = 'auto';
  }
  
  // Cerrar con tecla Escape
  document.addEventListener('keydown', function(event) {
    if (event.key === "Escape") {
      cerrarModal();
    }
  });
</script>