<div class="contenedor">
  <h2 class="page-title">Procedimientos</h2>
  <p class="page-description">
    Aqu√≠ encontrar√°s los procedimientos operativos documentados para las tareas del d√≠a a d√≠a.
  </p>

  <% const canWrite = (typeof can !== 'undefined' && can.procedimientos_write); %>

  <% if (canWrite) { %>
    <div class="panel">
      <h3 class="panel-title">Subir nuevo procedimiento</h3>

      <form action="/procesos/procedimientos/subir" method="POST" enctype="multipart/form-data" class="form-ticket">
        <label style="font-weight: bold; display: block; margin-bottom: 5px;">Nombre del documento</label>
        <input type="text" name="nombre_archivo" placeholder="Ej: Procedimiento de Bodega" required 
               style="width: 100%; padding: 8px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 4px;">

        <label style="font-weight: bold; display: block; margin-bottom: 5px;">Archivo</label>
        <input type="file" name="archivo" required style="margin-bottom: 10px;" accept=".pdf,.doc,.docx">
        
        <button type="submit" class="btn btn-primario">Subir archivo</button>
      </form>
    </div>
  <% } %>

  <div class="panel" style="margin-top: 18px;">
    <h3 class="panel-title">Archivos disponibles</h3>

    <% if (!archivos || archivos.length === 0) { %>
      <p class="no-data">No hay archivos cargados en esta secci√≥n.</p>
    <% } else { %>
      
      <div class="grid-archivos">
        <% archivos.forEach(function(archivo) { %>
          <%
            // FIX: no intentes cargar PDF como <img>. Eso deja el navegador ‚Äúcargando‚Äù mucho rato.
            let ext = (archivo.format || '').toLowerCase();
            let isPdf = ext === 'pdf' || (archivo.url || '').toLowerCase().endsWith('.pdf');
            let isDoc = ext === 'doc' || ext === 'docx' || (archivo.url || '').toLowerCase().endsWith('.doc') || (archivo.url || '').toLowerCase().endsWith('.docx');

            let thumbUrl = archivo.url;

            if (isPdf) {
              thumbUrl = '/img/pdf-placeholder.png';      // crea este archivo o usa el placeholder de abajo
            } else if (isDoc) {
              thumbUrl = '/img/doc-placeholder.png';
            } else {
              // si alg√∫n d√≠a guardas im√°genes en esta tabla, se ver√°n normal
              thumbUrl = archivo.url;
            }
          %>

          
          <div class="card-archivo">
            <div class="preview-container" onclick="abrirModal('<%= archivo.url %>', '<%= archivo.name %>')">
              <img
                src="<%= thumbUrl %>"
                alt="Doc"
                class="preview-img"
                loading="lazy"
                onerror="this.onerror=null; this.src='https://via.placeholder.com/300x200?text=Documento';"
              />

              <div class="icon-fallback" style="display: none;">üìÑ</div>
            </div>

            <div class="card-body">
              <h4 class="card-title" title="<%= archivo.name %>"><%= archivo.name %></h4>
              
              <div class="card-actions" style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                <a href="<%= archivo.url %>" target="_blank" download class="btn-secundario" style="font-size: 0.8rem; padding: 4px 8px;">
                  ‚¨á Descargar
                </a>

                <% if (canWrite) { %>
                  <div style="display: flex; gap: 8px;">
                    
                    <button type="button" onclick="abrirModalEditar('<%= archivo.id %>', '<%= archivo.name %>')" 
                            style="background:none; border:none; cursor:pointer; font-size:1.2rem;" title="Editar Nombre">
                      ‚úèÔ∏è
                    </button>

                    <form action="/procesos/procedimientos/eliminar" method="POST" onsubmit="return confirm('¬øEliminar este archivo?');" style="margin:0;">
                      <input type="hidden" name="public_id" value="<%= archivo.public_id %>">
                      <input type="hidden" name="db_id" value="<%= archivo.id %>">
                      <button type="submit" style="background:none; border:none; cursor:pointer; font-size:1.2rem;" title="Eliminar">
                        üóëÔ∏è
                      </button>
                    </form>
                  </div>
                <% } %>
              </div>
            </div>
          </div>
        <% }) %>
      </div>
    <% } %>
  </div>
</div>

<div id="pdfModal" class="modal-overlay" onclick="cerrarModal(event)">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="modalTitle" style="margin:0; font-size:1.1rem;">Visualizador</h3>
      <span class="modal-close" onclick="cerrarModal()">&times;</span>
    </div>
    <iframe id="pdfFrame" class="pdf-frame" src=""></iframe>
  </div>
</div>

<div id="editModal" class="modal-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000;">
  <div class="modal-content" style="max-width: 400px; margin: 100px auto; background: white; padding: 20px; border-radius: 8px;">
    <h3 style="margin-top: 0;">Editar Nombre del Documento</h3>
    
    <form action="/procesos/documento/editar" method="POST">
      <input type="hidden" name="return_to" value="/procesos/procedimientos">
      <input type="hidden" id="edit_id" name="id">
      
      <label style="display:block; margin-bottom: 5px;">Nuevo Nombre:</label>
      <input type="text" id="edit_nombre" name="nuevo_nombre" required style="width: 100%; padding: 8px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 4px;">
      
      <div style="text-align: right;">
        <button type="button" onclick="document.getElementById('editModal').style.display='none'" style="padding: 8px 15px; background: #ccc; border: none; border-radius: 4px; cursor: pointer; margin-right: 5px;">Cancelar</button>
        <button type="submit" class="btn btn-primario" style="padding: 8px 15px;">Guardar</button>
      </div>
    </form>
  </div>
</div>

<script>
  // Funciones PDF existentes
  function abrirModal(url, nombre) {
    const modal = document.getElementById('pdfModal');
    const iframe = document.getElementById('pdfFrame');
    const title = document.getElementById('modalTitle');
    iframe.src = 'https://docs.google.com/gview?url=' + encodeURIComponent(url) + '&embedded=true';
    title.innerText = nombre || 'Documento';
    modal.style.display = 'block';
  }
  function cerrarModal(event) {
    if (event && event.target !== document.getElementById('pdfModal') && event.target.className !== 'modal-close') return;
    document.getElementById('pdfModal').style.display = 'none';
    document.getElementById('pdfFrame').src = '';
  }

  // Nueva funci√≥n Editar
  function abrirModalEditar(id, nombreActual) {
    document.getElementById('edit_id').value = id;
    document.getElementById('edit_nombre').value = nombreActual;
    document.getElementById('editModal').style.display = 'block';
  }
</script>

<script>
(function () {
  const form = document.querySelector('form.form-ticket');
  if (!form) return;

  // OJO: en tu vista el input file se llama "archivo"
  const fileInput = form.querySelector('input[name="archivo"]');
  const nameInput = form.querySelector('input[name="nombre_archivo"]');
  const submitBtn = form.querySelector('button[type="submit"]');

  // Indicador simple de estado (lo creamos si no existe)
  let statusEl = document.getElementById('uploadStatus');
  if (!statusEl) {
    statusEl = document.createElement('div');
    statusEl.id = 'uploadStatus';
    statusEl.style.marginTop = '10px';
    statusEl.style.fontSize = '0.95rem';
    statusEl.style.color = '#555';
    form.appendChild(statusEl);
  }

  function setStatus(msg) { statusEl.textContent = msg || ''; }
  function setBusy(busy) {
    if (submitBtn) submitBtn.disabled = busy;
    if (fileInput) fileInput.disabled = busy;
    if (nameInput) nameInput.disabled = busy;
    if (submitBtn) submitBtn.textContent = busy ? 'Subiendo...' : 'Subir archivo';
  }

  function withTimeout(ms) {
    const controller = new AbortController();
    const t = setTimeout(() => controller.abort(), ms);
    return { controller, clear: () => clearTimeout(t) };
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const file = fileInput?.files?.[0];
    if (!file) return alert('Selecciona un archivo.');

    // Cloudinary Free: t√≠picamente 10MB por archivo en RAW
    if (file.size > 10 * 1024 * 1024) {
      return alert('El archivo supera los 10 MB permitidos.');
    }

    // Tipo (procedimientos/protocolos/reglamento)
    const tipo = location.pathname.split('/').pop();

    try {
      setBusy(true);
      setStatus('Obteniendo autorizaci√≥n de subida...');

      // 1) Signature (timeout corto)
      const sigTO = withTimeout(15000);
      const sigRes = await fetch(`/procesos/${encodeURIComponent(tipo)}/signature`, {
        method: 'GET',
        headers: { 'Accept': 'application/json' },
        signal: sigTO.controller.signal
      });
      sigTO.clear();

      if (!sigRes.ok) {
        const txt = await sigRes.text().catch(() => '');
        throw new Error(`No se pudo obtener la firma (HTTP ${sigRes.status}). ${txt ? 'Detalle: ' + txt : ''}`);
      }

      const sig = await sigRes.json();
      if (!sig.cloudName || !sig.apiKey || !sig.signature || !sig.timestamp || !sig.folder) {
        throw new Error('Signature inv√°lida (faltan datos). Revisa variables de entorno de Cloudinary en Render.');
      }

      // 2) Subida a Cloudinary (RAW) con timeout m√°s largo
      setStatus('Subiendo a Cloudinary...');
      const uploadUrl = `https://api.cloudinary.com/v1_1/${encodeURIComponent(sig.cloudName)}/raw/upload`;

      const fd = new FormData();
      fd.append('file', file);
      fd.append('api_key', sig.apiKey);
      fd.append('timestamp', String(sig.timestamp));
      fd.append('signature', sig.signature);
      fd.append('folder', sig.folder);
      // Importante: NO agregamos "resource_type" como par√°metro firmado; el endpoint ya es /raw/upload

      const upTO = withTimeout(120000);
      const uploadRes = await fetch(uploadUrl, { method: 'POST', body: fd, signal: upTO.controller.signal });
      upTO.clear();

      const uploadData = await uploadRes.json().catch(() => ({}));
      if (!uploadRes.ok || !uploadData.secure_url) {
        const msg = uploadData?.error?.message || 'Cloudinary rechaz√≥ el archivo.';
        throw new Error(msg);
      }

      // 3) Guardar en tu BD (JSON) con timeout
      setStatus('Registrando documento en el sistema...');
      const saveTO = withTimeout(20000);
      const saveRes = await fetch(`/procesos/${encodeURIComponent(tipo)}/subir`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
        body: JSON.stringify({
          nombre_archivo: nameInput?.value || file.name,
          secure_url: uploadData.secure_url,
          public_id: uploadData.public_id
        }),
        signal: saveTO.controller.signal
      });
      saveTO.clear();

      if (!saveRes.ok) {
        const txt = await saveRes.text().catch(() => '');
        throw new Error(`Error guardando en BD (HTTP ${saveRes.status}). ${txt ? 'Detalle: ' + txt : ''}`);
      }

      setStatus('Listo. Recargando...');
      location.reload();
    } catch (err) {
      console.error(err);
      alert(err.name === 'AbortError'
        ? 'La subida tard√≥ demasiado y se cancel√≥. Intenta de nuevo o revisa tu conexi√≥n.'
        : (err.message || 'Error subiendo documento.')
      );
      setStatus('');
      setBusy(false);
    }
  });
})();
</script>

