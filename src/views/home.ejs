<%
  function titleCase(s) {
    if (!s) return '';
    const palabras = String(s).toLowerCase().trim().split(/\s+/);
    if (palabras.length >= 3) {
      const n = palabras.slice(2).map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
      return `${n} ${palabras[0].charAt(0).toUpperCase() + palabras[0].slice(1)} ${palabras[1].charAt(0).toUpperCase() + palabras[1].slice(1)}`;
    }
    return palabras.map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
  }
  const mesNum = new Date().getMonth() + 1;
  let cumpleaniosOrdenados = [];
  if (typeof cumpleaniosMes !== 'undefined' && cumpleaniosMes) {
    cumpleaniosOrdenados = [...cumpleaniosMes].sort((a, b) => {
      const dHoy = (typeof diaHoy !== 'undefined') ? diaHoy : new Date().getDate(); 
      const aPasado = a.dia < dHoy; const bPasado = b.dia < dHoy;
      if (aPasado !== bPasado) return aPasado ? 1 : -1;
      return a.dia - b.dia;
    });
  }
%>

<style>
  /* --- FONDO EST√ÅTICO HOME --- */
  body {
    background: url('/img/fondo-home.png') no-repeat center center fixed !important;
    background-size: cover !important;
  }
  main { background: transparent !important; padding-top: 20px; }

  /* --- BANNERS SUPERIORES --- */
  .home-top-banners {
    display: flex;
    gap: 20px;
    margin-bottom: 30px;
    justify-content: space-between;
  }

  .banner-info {
    flex: 1;
    padding: 15px 20px;
    border-radius: 8px; /* Bordes menos redondeados seg√∫n imagen */
    color: #003a70; /* Azul oscuro para texto */
    font-weight: 700;
    font-size: 1.2rem;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    text-decoration: none;
    transition: transform 0.2s;
  }
  
  /* Banner D√≥lar */
  .banner-dolar.alcista {
    background-color: #88c543; /* Verde lima */
  }
  .banner-dolar.bajista {
    background-color: #e57373; /* Rojo suave */
    color: white;
  }
  .trend-arrow { font-size: 1.5rem; margin-left: 10px; }

  /* Banner Soporte */
  .banner-soporte {
    background-color: #88c543; /* Verde lima */
    cursor: pointer;
  }
  .banner-soporte:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0,0,0,0.15);
  }
  .icon-click { font-size: 1.4rem; margin-left: 10px; }


  /* --- TITULOS --- */
  .section-title-destacados { 
    color: #003a70; 
    margin: 0 0 10px 0; /* M√°s cerca del carrusel */
    font-size: 1.6rem; /* Letra m√°s ancha/grande */
    font-weight: 900; /* Negrita fuerte */
    text-transform: uppercase; 
    letter-spacing: 0.5px; 
    text-shadow: 1px 1px 0px rgba(255,255,255,0.5); 
  }

  /* --- CARRUSEL --- */
  .news-carousel-container {
    position: relative; width: 100%; height: 350px;
    border-radius: 0; /* Cuadrado seg√∫n imagen */
    overflow: hidden;
    box-shadow: 0 6px 12px rgba(0,0,0,0.25);
    background: #003a70; /* Fondo azul oscuro por si carga */
    border: none;
  }
  .news-slide { display: none; width: 100%; height: 100%; }
  .news-slide.active { display: block; animation: fadeNews 1.5s ease-in-out; }
  @keyframes fadeNews { from {opacity: 0;} to {opacity: 1;} }
  
  .news-slide a { display: block; width: 100%; height: 100%; text-decoration: none; position: relative; }
  .news-slide img { width: 100%; height: 100%; object-fit: cover; }
  
  /* Textos dentro del carrusel */
  .history-overlay {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    display: flex; flex-direction: column; justify-content: center; align-items: center;
    text-align: center; padding: 40px; 
    background: rgba(0, 58, 112, 0.4); /* Filtro azul sobre la imagen de fondo */
  }
  .history-text { color: #fff; font-size: 2rem; font-weight: 800; text-shadow: 0 2px 4px rgba(0,0,0,0.8); line-height: 1.3; text-transform: uppercase; }
  
  .news-caption {
    position: absolute; bottom: 0; width: 100%;
    background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0) 100%);
    color: #fff; padding: 30px 20px;
    font-size: 1.5rem; font-weight: bold; text-align: center;
    text-shadow: 0 2px 4px rgba(0,0,0,0.8);
  }

  /* FLECHAS VERDES TRIANGULARES */
  .news-ctrl {
    position: absolute; top: 50%; transform: translateY(-50%);
    background: transparent; border: none; cursor: pointer; z-index: 10; padding: 0;
    width: 0; height: 0; 
    transition: transform 0.2s;
  }
  .news-prev { 
    left: 20px; 
    border-top: 20px solid transparent;
    border-bottom: 20px solid transparent; 
    border-right: 30px solid #88c543; /* Verde */
  }
  .news-next { 
    right: 20px; 
    border-top: 20px solid transparent;
    border-bottom: 20px solid transparent;
    border-left: 30px solid #88c543; /* Verde */
  }
  .news-ctrl:hover { transform: translateY(-50%) scale(1.1); }

  /* PUNTOS VERDES */
  .news-dots-container {
    position: absolute; bottom: 15px; left: 50%; transform: translateX(-50%); display: flex; gap: 10px; z-index: 15;
  }
  .news-dot { height: 12px; width: 12px; background-color: rgba(255, 255, 255, 0.5); border-radius: 50%; cursor: pointer; transition: all 0.3s; }
  .news-dot:hover { background-color: #88c543; }
  .news-dot.active { background-color: #88c543; transform: scale(1.2); }

  /* --- GRID DE EVENTOS (AGRANDADOS) --- */
  .eventos-header-wrapper {
    margin-top: 40px; /* Separaci√≥n del carrusel */
    margin-bottom: 10px; /* Pegado a las tarjetas */
  }
  .eventos-portada-grid {
    display: grid;
    /* Tarjetas mucho m√°s grandes: min 250px */
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 20px;
  }
  .card-evento-mini {
    background: #fff;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    transition: transform 0.2s;
    text-decoration: none;
    color: inherit;
    border: 1px solid #dde3ec;
    display: flex;
    flex-direction: column;
  }
  .card-evento-mini:hover { transform: translateY(-5px); box-shadow: 0 8px 15px rgba(0,0,0,0.15); }
  
  .evento-mini-img-container {
    width: 100%;
    height: 180px; /* Altura aumentada */
    overflow: hidden;
  }
  .evento-mini-img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s; }
  .card-evento-mini:hover .evento-mini-img { transform: scale(1.05); }

  .evento-mini-nombre {
    padding: 15px;
    font-size: 1rem;
    font-weight: 700;
    color: #444;
    text-align: left;
    border-top: 1px solid #eee;
  }

  /* --- LAYOUT GENERAL --- */
  .home-layout {
    display: flex; gap: 30px; align-items: flex-start;
  }
  .home-left { flex: 1; } /* Ocupa todo el espacio posible */
  
  .home-right { 
    flex: 0 0 320px; /* Ancho fijo sidebar */
    margin-top: 0; /* Alineado arriba por defecto */
  }
  
  /* Ajuste para alinear t√≠tulo cumplea√±os con t√≠tulo galer√≠a */
  /* Galer√≠a tiene margin-top 40px + titulo margin. Cumplea√±os necesita bajar para alinear */
  .spacer-cumple { height: 420px; } /* Espacio para bajar los cumplea√±os bajo el nivel del carrusel aprox */

  @media (max-width: 900px) {
    .home-layout { flex-direction: column; }
    .home-right { width: 100%; margin-top: 30px; }
    .spacer-cumple { display: none; }
    .home-top-banners { flex-direction: column; }
  }
</style>

<div class="home-top-banners">
  
  <% if (typeof usdTrend !== 'undefined' && usdTrend === 'bajista') { %>
    <div class="banner-info banner-dolar bajista">
      D√≥lar actual observado: <%= typeof usdHoy !== 'undefined' ? usdHoy : '---' %>
      <span class="trend-arrow">‚¨á</span>
    </div>
  <% } else { %>
    <div class="banner-info banner-dolar alcista">
      D√≥lar actual observado: <%= typeof usdHoy !== 'undefined' ? usdHoy : '---' %>
      <span class="trend-arrow">‚¨Ü</span>
    </div>
  <% } %>

  <a href="/sistemas/tickets" class="banner-info banner-soporte" title="Ir a soporte">
    Necesitas asistencia? Env√≠a un ticket a soporte
    <span class="icon-click">üëÜ</span>
  </a>

</div>

<div class="home-layout">
  
  <div class="home-left">
    
    <h3 class="section-title-destacados">Destacados de la semana</h3>

    <% if (typeof mixedCarousel !== 'undefined' && mixedCarousel && mixedCarousel.length > 0) { %>
      <div class="news-carousel-container">
        
        <button class="news-ctrl news-prev" onclick="plusNews(-1)"></button>
        <button class="news-ctrl news-next" onclick="plusNews(1)"></button>

        <% mixedCarousel.forEach((item, index) => { %>
          <div class="news-slide <%= index === 0 ? 'active' : '' %>">
            <a href="<%= item.link %>" title="Ver detalle">
              <img src="<%= item.imagen %>" alt="Destacado">
              
              <% if (item.tipo === 'historial') { %>
                <div class="history-overlay">
                  <div class="history-text"><%= item.titulo %></div>
                </div>
              <% } else { %>
                <div class="news-caption">
                  <%= item.titulo %>
                </div>
              <% } %>
            </a>
          </div>
        <% }); %>

        <div class="news-dots-container">
          <% mixedCarousel.forEach((_, i) => { %>
            <span class="news-dot <%= i === 0 ? 'active' : '' %>" onclick="currentNews(<%= i + 1 %>)"></span>
          <% }); %>
        </div>
      </div>
    <% } else { %>
      <div style="background: rgba(255,255,255,0.9); padding: 20px; border-radius: 8px;"><p>No hay destacados.</p></div>
    <% } %>

    <div class="eventos-header-wrapper">
      <h3 class="section-title-destacados">Galer√≠a de Eventos</h3>
    </div>

    <% if (typeof eventosPortadas !== 'undefined' && eventosPortadas.length > 0) { %>
      <div class="eventos-portada-grid">
        <% eventosPortadas.forEach(ev => { %>
          <a href="/marketing/eventos/<%= ev.slug %>" class="card-evento-mini" title="<%= ev.nombre %>">
            <div class="evento-mini-img-container">
              <img src="<%= ev.imagen %>" alt="<%= ev.nombre %>" class="evento-mini-img">
            </div>
            <div class="evento-mini-nombre">
              <%= ev.nombre %>
            </div>
          </a>
        <% }); %>
      </div>
    <% } else { %>
      <p style="color:white; text-shadow: 1px 1px 2px black;">No hay eventos con portada definida.</p>
    <% } %>

  </div>

  <div class="home-right">
    
    <div class="spacer-cumple"></div> 

    <div class="tarjeta" style="border: 1px solid #dde3ec;">
      <h3 style="margin-top:0; color:#003a70;">Cumplea√±os de <%= (typeof mesNombre !== 'undefined') ? mesNombre : 'Mes Actual' %></h3>
      
      <% if (!cumpleaniosOrdenados || cumpleaniosOrdenados.length === 0) { %>
        <p>No hay cumplea√±os registrados.</p>
      <% } else { %>
        <div class="cumple-cards">
          <% const dHoy = (typeof diaHoy !== 'undefined') ? diaHoy : new Date().getDate(); %>
          <% cumpleaniosOrdenados.forEach((p) => { 
            let estadoClase = (p.dia < dHoy) ? 'cumple-pasado' : (p.dia === dHoy ? 'cumple-hoy' : 'cumple-futuro');
          %>
            <div class="cumple-card <%= estadoClase %>">
              <div class="cumple-fecha"><span class="cumple-dia"><%= p.dia %>/<%= mesNum %></span></div>
              <div class="cumple-info">
                <div class="cumple-nombre"><%= titleCase(p.nombre) %></div>
                <div class="cumple-area"><%= titleCase(p.area) %></div>
              </div>
            </div>
          <% }); %>
        </div>
      <% } %>
    </div>
  </div>

</div>

<script>
  // Carrusel Mixto (Manual + Dots + Auto + Reiniciable)
  let newsIndex = 1;
  let autoSlideTimer;
  const newsSlides = document.getElementsByClassName("news-slide");
  const newsDots = document.getElementsByClassName("news-dot");

  function startAutoSlide() {
    autoSlideTimer = setInterval(() => { plusNews(1, false); }, 10000);
  }
  function resetAutoSlide() {
    clearInterval(autoSlideTimer);
    startAutoSlide();
  }
  if (newsSlides.length > 0) {
    showNews(newsIndex);
    startAutoSlide();
  }
  function plusNews(n, manual = true) {
    showNews(newsIndex += n);
    if (manual) resetAutoSlide();
  }
  function currentNews(n) {
    showNews(newsIndex = n);
    resetAutoSlide();
  }
  function showNews(n) {
    let i;
    if (newsSlides.length === 0) return;
    if (n > newsSlides.length) {newsIndex = 1}    
    if (n < 1) {newsIndex = newsSlides.length}
    for (i = 0; i < newsSlides.length; i++) {
      newsSlides[i].style.display = "none";
      newsSlides[i].classList.remove("active");
    }
    for (i = 0; i < newsDots.length; i++) {
      newsDots[i].classList.remove("active");
    }
    newsSlides[newsIndex-1].style.display = "block";  
    newsSlides[newsIndex-1].classList.add("active");
    if (newsDots.length > 0) newsDots[newsIndex-1].classList.add("active");
  }
</script>