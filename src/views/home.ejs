<%
  // 1. Funciones y lógica previa (sin cambios)
  function titleCase(s) {
    if (!s) return '';
    const palabras = String(s).toLowerCase().trim().split(/\s+/);
    if (palabras.length >= 3) {
      const apellido1 = palabras[0];
      const apellido2 = palabras[1];
      const nombres = palabras.slice(2); 
      const nombreFormateado = nombres.map(n => n.charAt(0).toUpperCase() + n.slice(1)).join(' ');
      const ap1Formateado = apellido1.charAt(0).toUpperCase() + apellido1.slice(1);
      const ap2Formateado = apellido2.charAt(0).toUpperCase() + apellido2.slice(1);
      return `${nombreFormateado} ${ap1Formateado} ${ap2Formateado}`;
    } else if (palabras.length === 2) {
      const apellido = palabras[0];
      const nombre = palabras[1];
      return `${nombre.charAt(0).toUpperCase() + nombre.slice(1)} ${apellido.charAt(0).toUpperCase() + apellido.slice(1)}`;
    }
    return palabras.map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
  }

  const mesNum = new Date().getMonth() + 1;

  // 2. Ordenar cumpleaños
  let cumpleaniosOrdenados = [];
  if (typeof cumpleaniosMes !== 'undefined' && cumpleaniosMes) {
    cumpleaniosOrdenados = [...cumpleaniosMes].sort((a, b) => {
      const dHoy = (typeof diaHoy !== 'undefined') ? diaHoy : new Date().getDate(); 
      const aPasado = a.dia < dHoy;
      const bPasado = b.dia < dHoy;
      if (aPasado !== bPasado) return aPasado ? 1 : -1;
      return a.dia - b.dia;
    });
  }
%>

<style>
  /* Hacemos transparente el fondo principal para ver el carrusel */
  body, main {
    background: transparent !important;
  }

  /* Contenedor fijo al fondo */
  .fullscreen-carousel {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1; /* Detrás de todo */
    overflow: hidden;
  }

  /* Cada slide ocupa toda la pantalla */
  .bg-slide {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: none; /* JS lo maneja */
  }

  /* La imagen cubre todo sin deformarse */
  .bg-slide img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    filter: brightness(0.6); /* Oscurecemos un poco la foto para que resalten las tarjetas */
  }

  /* Animación suave */
  .fade-bg {
    animation-name: fadeBg;
    animation-duration: 2s;
  }

  @keyframes fadeBg {
    from {opacity: 0.4} 
    to {opacity: 1}
  }

  /* Ajuste para que el título "Bienvenida" se lea bien sobre fotos */
  h2 {
    color: #fff; /* Título en blanco */
    text-shadow: 0 2px 4px rgba(0,0,0,0.6);
  }
</style>


<% if (typeof eventosCarousel !== 'undefined' && eventosCarousel && eventosCarousel.length > 0) { %>
  <div class="fullscreen-carousel">
    <% for (let i = 0; i < eventosCarousel.length; i++) { 
         let evento = eventosCarousel[i];
         let displayStyle = (i === 0) ? 'display:block;' : 'display:none;';
    %>
      <div class="bg-slide fade-bg" style="<%= displayStyle %>">
        <img src="<%= evento.imagen %>" alt="Fondo Evento">
        </div>
    <% } %>
  </div>
<% } else { %>
  <div class="fullscreen-carousel" style="background: #003a70;"></div>
<% } %>


<h2>Bienvenida/o a la intranet de Transworld</h2>

<div class="home-layout">
  
  <div class="home-left">
    <a href="/sistemas/tickets" class="home-ti-link" title="Ir a Tickets">
      <div class="home-ti-card">
        <img src="/img/Img%20Servicios%20TI.png" alt="Servicios TI" class="home-ti-img" />
      </div>
    </a>
    
    </div>

  <div class="home-right">
    
    <div class="tarjeta tarjeta-usd">
      <div class="usd-label">Dólar Observado</div>
      <p class="usd-valor">$<%= (typeof usdHoy !== 'undefined') ? usdHoy : '---' %></p>
      <div class="chart-box">
        <canvas id="usdChart"></canvas>
      </div>
    </div>

    <div class="tarjeta">
      <h3>Cumpleaños de <%= (typeof mesNombre !== 'undefined') ? mesNombre : 'Mes Actual' %></h3>

      <% if (!cumpleaniosOrdenados || cumpleaniosOrdenados.length === 0) { %>
        <p>No hay cumpleaños registrados para este mes.</p>
      <% } else { %>
        <div class="cumple-cards">
          <% 
             const dHoy = (typeof diaHoy !== 'undefined') ? diaHoy : new Date().getDate();
          %>
          <% cumpleaniosOrdenados.forEach((p) => { 
            let estadoClase = (p.dia < dHoy) ? 'cumple-pasado' : (p.dia === dHoy ? 'cumple-hoy' : 'cumple-futuro');
          %>
            <div class="cumple-card <%= estadoClase %>">
              <div class="cumple-fecha">
                <span class="cumple-dia"><%= p.dia %>/<%= mesNum %></span>
              </div>
              <div class="cumple-info">
                <div class="cumple-nombre"><%= titleCase(p.nombre) %></div>
                <div class="cumple-area"><%= titleCase(p.area) %></div>
              </div>
            </div>
          <% }); %>
        </div>
      <% } %>
    </div>

  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  // --- 1. Gráfico USD ---
  const rawData = '<%- (typeof usdHistorico !== "undefined") ? JSON.stringify(usdHistorico) : "[]" %>';
  const datosHistoricos = JSON.parse(rawData);

  const ctx = document.getElementById('usdChart').getContext('2d');
  
  if (datosHistoricos.length > 0) {
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: datosHistoricos.map(d => new Date(d.fecha).getDate()),
        datasets: [{
          label: 'USD',
          data: datosHistoricos.map(d => d.valor),
          borderColor: '#4caf50',
          backgroundColor: 'rgba(76, 175, 80, 0.1)',
          borderWidth: 2,
          fill: true,
          pointRadius: 2,
          tension: 0.3
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false }, tooltip: { enabled: true } },
        scales: {
          x: { display: false },
          y: { 
            display: false,
            suggestedMin: Math.min(...datosHistoricos.map(d => d.valor)) - 5,
            suggestedMax: Math.max(...datosHistoricos.map(d => d.valor)) + 5
          }
        }
      }
    });
  }

  // --- 2. Lógica del Carrusel de Fondo ---
  let slideIndex = 0;
  // Apuntamos a la nueva clase "bg-slide"
  const slides = document.getElementsByClassName("bg-slide");

  if (slides.length > 0) {
    showSlides(); 
  }

  function showSlides() {
    for (let i = 0; i < slides.length; i++) {
      slides[i].style.display = "none";  
    }
    
    slideIndex++;
    if (slideIndex > slides.length) { slideIndex = 1; }    
    
    if (slides[slideIndex-1]) {
      slides[slideIndex-1].style.display = "block";  
    }

    setTimeout(showSlides, 5000); // 5 segundos por foto
  }
</script>